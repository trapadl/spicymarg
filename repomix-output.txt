This file is a merged representation of the entire codebase, combined into a single document by Repomix.

================================================================
File Summary
================================================================

Purpose:
--------
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

File Format:
------------
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A separator line (================)
  b. The file path (File: path/to/file)
  c. Another separator line
  d. The full contents of the file
  e. A blank line

Usage Guidelines:
-----------------
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

Notes:
------
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)

Additional Info:
----------------

================================================================
Directory Structure
================================================================
.gitignore
all supabase information.txt
config-overrides.js
hash-password.js
package.json
public/index.html
public/manifest.json
public/robots.txt
README.md
src/api/brevo.js
src/api/supabase.js
src/App.css
src/App.js
src/App.test.js
src/components/admin/FunnelStats.css
src/components/admin/FunnelStats.jsx
src/components/admin/MetricsDashboard.css
src/components/admin/MetricsDashboard.jsx
src/components/admin/MetricsForm.css
src/components/admin/MetricsForm.jsx
src/components/admin/MetricsTable.css
src/components/admin/MetricsTable.jsx
src/components/common/Button.css
src/components/common/Button.jsx
src/components/common/Footer.css
src/components/common/Footer.jsx
src/components/common/Header.css
src/components/common/Header.jsx
src/components/common/Input.css
src/components/common/Input.jsx
src/components/common/Layout.css
src/components/common/Layout.jsx
src/components/confirm/VisitConfirm.jsx
src/components/landing/LandingForm.jsx
src/components/voucher/OtpVerify.jsx
src/components/voucher/VoucherDisplay.jsx
src/components/voucher/VoucherForm.jsx
src/index.css
src/index.js
src/logo.svg
src/pages/AdminPage.css
src/pages/AdminPage.jsx
src/pages/ConfirmPage.jsx
src/pages/LandingPage.jsx
src/pages/VoucherPage.jsx
src/reportWebVitals.js
src/setupTests.js
supabase/.gitignore
supabase/config.toml
supabase/functions/aggregate-monthly-metrics/index.ts
supabase/functions/verify-admin/index.ts
supabase/schema.sql
webpack.config.js

================================================================
Files
================================================================

================
File: all supabase information.txt
================
[
  {
    "result": {
      "columns": [
        {
          "table_name": "funnel_metrics",
          "column_name": "total_leads",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "claimed_vouchers",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "first_visits",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "second_visits",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "third_visits",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "stage0_conv_pct",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "stage1_conv_pct",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "stage2_conv_pct",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "stage3_conv_pct",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_metrics",
          "column_name": "overall_conv_pct",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "month",
          "data_type": "date",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "leads",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "vouchers_claimed",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "first_visits",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "second_visits",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "third_visits",
          "data_type": "bigint",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "stage0_ad_spend",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "stage1_cogs",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "stage2_sms_cost",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "stage3_cogs",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "total_revenue",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "total_costs",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "gross_profit",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "cost_per_lead",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "funnel_profitability",
          "column_name": "cost_per_visit",
          "data_type": "numeric",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "guests",
          "column_name": "id",
          "data_type": "uuid",
          "is_nullable": "NO",
          "column_default": "gen_random_uuid()"
        },
        {
          "table_name": "guests",
          "column_name": "email",
          "data_type": "text",
          "is_nullable": "NO",
          "column_default": null
        },
        {
          "table_name": "guests",
          "column_name": "dob",
          "data_type": "date",
          "is_nullable": "NO",
          "column_default": null
        },
        {
          "table_name": "guests",
          "column_name": "phone",
          "data_type": "text",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "guests",
          "column_name": "full_name",
          "data_type": "text",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "guests",
          "column_name": "stage",
          "data_type": "integer",
          "is_nullable": "YES",
          "column_default": "0"
        },
        {
          "table_name": "guests",
          "column_name": "created_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "YES",
          "column_default": "now()"
        },
        {
          "table_name": "guests",
          "column_name": "last_stage_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "YES",
          "column_default": "now()"
        },
        {
          "table_name": "guests",
          "column_name": "marketing_opt_in",
          "data_type": "boolean",
          "is_nullable": "YES",
          "column_default": "true"
        },
        {
          "table_name": "guests",
          "column_name": "sms_opt_out",
          "data_type": "boolean",
          "is_nullable": "YES",
          "column_default": "false"
        },
        {
          "table_name": "monthly_metrics",
          "column_name": "month",
          "data_type": "date",
          "is_nullable": "NO",
          "column_default": null
        },
        {
          "table_name": "monthly_metrics",
          "column_name": "stage0_ad_spend",
          "data_type": "numeric",
          "is_nullable": "NO",
          "column_default": "0"
        },
        {
          "table_name": "monthly_metrics",
          "column_name": "stage1_cogs",
          "data_type": "numeric",
          "is_nullable": "NO",
          "column_default": "0"
        },
        {
          "table_name": "monthly_metrics",
          "column_name": "stage2_sms_cost",
          "data_type": "numeric",
          "is_nullable": "NO",
          "column_default": "0"
        },
        {
          "table_name": "monthly_metrics",
          "column_name": "stage3_cogs",
          "data_type": "numeric",
          "is_nullable": "NO",
          "column_default": "0"
        },
        {
          "table_name": "monthly_metrics",
          "column_name": "total_revenue",
          "data_type": "numeric",
          "is_nullable": "NO",
          "column_default": "0"
        },
        {
          "table_name": "monthly_metrics",
          "column_name": "notes",
          "data_type": "text",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "phone_otps",
          "column_name": "id",
          "data_type": "uuid",
          "is_nullable": "NO",
          "column_default": "gen_random_uuid()"
        },
        {
          "table_name": "phone_otps",
          "column_name": "guest_id",
          "data_type": "uuid",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "phone_otps",
          "column_name": "otp_code",
          "data_type": "character",
          "is_nullable": "NO",
          "column_default": null
        },
        {
          "table_name": "phone_otps",
          "column_name": "expires_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "NO",
          "column_default": null
        },
        {
          "table_name": "phone_otps",
          "column_name": "created_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "YES",
          "column_default": "now()"
        },
        {
          "table_name": "visits",
          "column_name": "id",
          "data_type": "uuid",
          "is_nullable": "NO",
          "column_default": "gen_random_uuid()"
        },
        {
          "table_name": "visits",
          "column_name": "guest_id",
          "data_type": "uuid",
          "is_nullable": "YES",
          "column_default": null
        },
        {
          "table_name": "visits",
          "column_name": "visit_number",
          "data_type": "integer",
          "is_nullable": "NO",
          "column_default": null
        },
        {
          "table_name": "visits",
          "column_name": "created_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "YES",
          "column_default": "now()"
        }
      ],
      "functions": [
        {
          "function_name": "generate_secure_token",
          "return_type": "text",
          "arguments": "bytes_length integer DEFAULT 32",
          "schema_name": "public",
          "function_definition": "\r\n  SELECT encode(gen_random_bytes(bytes_length), 'hex');\r\n"
        },
        {
          "function_name": "update_guest_stage",
          "return_type": "boolean",
          "arguments": "p_guest_id uuid, p_new_stage integer",
          "schema_name": "public",
          "function_definition": "\r\nDECLARE\r\n  v_email TEXT;\r\nBEGIN\r\n  -- Update the guest's stage\r\n  UPDATE guests \r\n  SET stage = p_new_stage, \r\n      last_stage_at = now() \r\n  WHERE id = p_guest_id \r\n  RETURNING email INTO v_email;\r\n  \r\n  -- Return false if guest not found\r\n  IF v_email IS NULL THEN\r\n    RETURN FALSE;\r\n  END IF;\r\n  \r\n  -- In a real implementation, this would call Brevo via an Edge Function\r\n  -- For now, this is a placeholder\r\n  \r\n  RETURN TRUE;\r\nEND;\r\n"
        },
        {
          "function_name": "verify_otp",
          "return_type": "boolean",
          "arguments": "p_guest_id uuid, p_otp_code text",
          "schema_name": "public",
          "function_definition": "\r\nDECLARE\r\n  v_valid BOOLEAN;\r\nBEGIN\r\n  -- Check if OTP is valid and not expired\r\n  SELECT EXISTS (\r\n    SELECT 1 \r\n    FROM phone_otps \r\n    WHERE guest_id = p_guest_id \r\n    AND otp_code = p_otp_code \r\n    AND expires_at > now()\r\n  ) INTO v_valid;\r\n  \r\n  -- If valid, delete the OTP (one-time use)\r\n  IF v_valid THEN\r\n    DELETE FROM phone_otps WHERE guest_id = p_guest_id;\r\n  END IF;\r\n  \r\n  RETURN v_valid;\r\nEND;\r\n"
        }
      ],
      "triggers": [
        {
          "trigger_name": "update_objects_updated_at",
          "event_manipulation": "UPDATE",
          "event_object_table": "objects",
          "action_statement": "EXECUTE FUNCTION storage.update_updated_at_column()"
        },
        {
          "trigger_name": "tr_check_filters",
          "event_manipulation": "INSERT",
          "event_object_table": "subscription",
          "action_statement": "EXECUTE FUNCTION realtime.subscription_check_filters()"
        },
        {
          "trigger_name": "tr_check_filters",
          "event_manipulation": "UPDATE",
          "event_object_table": "subscription",
          "action_statement": "EXECUTE FUNCTION realtime.subscription_check_filters()"
        }
      ],
      "policies": [
        {
          "schema_name": "public",
          "table_name": "guests",
          "policy_name": "Enable insert for anonymous users",
          "policy_type": "PERMISSIVE",
          "roles": [
            "public"
          ],
          "policy_condition": null,
          "policy_check": "(auth.role() = 'anon'::text)"
        },
        {
          "schema_name": "public",
          "table_name": "guests",
          "policy_name": "Enable read access for authenticated users",
          "policy_type": "PERMISSIVE",
          "roles": [
            "public"
          ],
          "policy_condition": "(auth.role() = 'authenticated'::text)",
          "policy_check": null
        },
        {
          "schema_name": "public",
          "table_name": "monthly_metrics",
          "policy_name": "Authenticated users can manage metrics",
          "policy_type": "PERMISSIVE",
          "roles": [
            "public"
          ],
          "policy_condition": "(auth.role() = 'authenticated'::text)",
          "policy_check": null
        },
        {
          "schema_name": "public",
          "table_name": "phone_otps",
          "policy_name": "Service role can manage OTPs",
          "policy_type": "PERMISSIVE",
          "roles": [
            "public"
          ],
          "policy_condition": "(auth.role() = 'service_role'::text)",
          "policy_check": null
        },
        {
          "schema_name": "public",
          "table_name": "visits",
          "policy_name": "Service role can manage visits",
          "policy_type": "PERMISSIVE",
          "roles": [
            "public"
          ],
          "policy_condition": "(auth.role() = 'service_role'::text)",
          "policy_check": null
        }
      ]
    }
  }
]

================
File: config-overrides.js
================
// config-overrides.js
const webpack = require('webpack');

module.exports = function override(config, env) {
  // Add fallbacks for node modules
  config.resolve.fallback = {
    ...config.resolve.fallback,
    "crypto": require.resolve("crypto-browserify"),
    "stream": require.resolve("stream-browserify"),
    "buffer": require.resolve("buffer/"),
    "util": require.resolve("util/"),
    "path": require.resolve("path-browserify"),
    "assert": require.resolve("assert/"),
    "os": require.resolve("os-browserify/browser"),
    "zlib": require.resolve("browserify-zlib"),
    "url": require.resolve("url/"),
    "vm": require.resolve("vm-browserify"), // Add this line
    "fs": false,
    "child_process": false,
    "net": false,
    "tls": false,
  };

  // Add plugins
  config.plugins = [
    ...config.plugins,
    new webpack.ProvidePlugin({
      Buffer: ['buffer', 'Buffer'],
      process: 'process/browser',
    }),
  ];

  return config;
};

================
File: hash-password.js
================
// hash-password.js
const bcrypt = require('bcryptjs'); // Use bcryptjs instead of bcrypt

// The password you want to hash
const password = process.argv[2] || 'default-admin-password';

// Generate the hash with a salt round of 10
bcrypt.hash(password, 10, function(err, hash) {
  if (err) {
    console.error('Error generating hash:', err);
    return;
  }
  
  console.log('\nHashed Password:');
  console.log(hash);
  console.log('\nAdd this to your .env file as:');
  console.log(`VITE_ADMIN_HASHED_PASSWORD=${hash}`);
  // Or for create-react-app
  console.log(`REACT_APP_ADMIN_HASHED_PASSWORD=${hash}`);
});

================
File: src/api/brevo.js
================
// src/api/brevo.js

// Constants for templates (ensure these match your Brevo Template IDs)
export const EmailTemplates = {
  SIGNUP_VOUCHER: 1,       // Initial free margarita voucher (uses params)
  FIRST_VISIT_THANKS: 2,   // Thank you + Icey Margarita coupon (will use contact attributes)
  SECOND_VISIT_THANKS: 3,  // Thank you + Free cocktail coupon (will use contact attributes)
  FINAL_THANKS: 4          // Final thank you after completion (uses params)
};

// Get API key from environment
const BREVO_API_KEY = process.env.REACT_APP_BREVO_API_KEY || import.meta.env?.VITE_BREVO_API_KEY;

if (!BREVO_API_KEY) {
  console.warn('Brevo API key missing. Check your environment variables.');
}

const API_BASE_URL = 'https://api.brevo.com/v3';
// const APP_BASE_URL = window.location.origin; // Not strictly needed here if paths are relative

// Request headers
const getHeaders = () => {
  return {
    'Accept': 'application/json',
    'Content-Type': 'application/json',
    'api-key': BREVO_API_KEY
  };
};

// Create or update contact in Brevo
export async function updateContact(email, attributes, listIds = []) {
  try {
    console.log('[Brevo API] Updating contact:', email, 'Attributes:', JSON.stringify(attributes), 'List IDs:', listIds);
    
    const response = await fetch(`${API_BASE_URL}/contacts`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({
        email,
        attributes,
        listIds,
        updateEnabled: true
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('[Brevo API] Failed to update contact. Status:', response.status, 'Response:', errorData);
      throw new Error(errorData.message || 'Failed to update contact');
    }
    
    console.log('[Brevo API] Contact updated successfully for:', email);
    return { success: true };
  } catch (error) {
    console.error('[Brevo API] Error updating contact:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred while updating contact'
    };
  }
}

export async function sendTransactionalEmail(templateId, recipient, params = {}) {
  try {
    console.log('[Brevo API] Sending transactional email. Template ID:', templateId, 'Recipient:', recipient.email, 'Params:', JSON.stringify(params));
    
    const response = await fetch(`${API_BASE_URL}/smtp/email`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({
        templateId: parseInt(templateId),
        to: [{ 
          email: recipient.email, 
          name: recipient.name || recipient.email
        }],
        params,
        headers: {
          'X-Mailin-custom': 'trap-margarita-funnel'
        }
      })
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      console.error('[Brevo API] Failed to send transactional email. Status:', response.status, 'Response:', errorData);
      throw new Error(errorData.message || 'Failed to send email');
    }
    
    const data = await response.json();
    console.log('[Brevo API] Transactional email sent successfully. Message ID:', data.messageId);
    return { 
      success: true,
      messageId: data.messageId 
    };
  } catch (error) {
    console.error('[Brevo API] Error sending transactional email:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred while sending email'
    };
  }
}

export async function sendSms(phoneNumber, message, senderName = 'Trap') {
  try {
    let cleaned = phoneNumber.replace(/\s+|\(|\)|\-/g, '');
    let formattedPhone;
    if (cleaned.startsWith('+61')) { formattedPhone = cleaned; }
    else if (cleaned.startsWith('04')) { formattedPhone = `+614${cleaned.substring(2)}`; }
    else if (cleaned.startsWith('0')) { formattedPhone = `+61${cleaned.substring(1)}`; }
    else if (/^\d+$/.test(cleaned)) { formattedPhone = `+61${cleaned}`; }
    else if (cleaned.startsWith('+')) { formattedPhone = cleaned; }
    else { formattedPhone = `+61${cleaned}`; }
    
    console.log(`[Brevo API] Sending SMS to ${formattedPhone}: "${message}"`);
    
    const response = await fetch(`${API_BASE_URL}/transactionalSMS/send`, {
      method: 'POST',
      headers: getHeaders(),
      body: JSON.stringify({
        sender: senderName,
        recipient: formattedPhone,
        content: message,
        type: "marketing", 
        unicodeEnabled: true
      })
    });
  
    if (!response.ok) {
      const errorData = await response.json();
      console.error('[Brevo API] Failed to send SMS. Status:', response.status, 'Response:', errorData);
      throw new Error(errorData.message || 'Failed to send SMS');
    }
    
    const data = await response.json();
    console.log('[Brevo API] SMS sent successfully. Message ID:', data.messageId);
    return { 
      success: true,
      messageId: data.messageId 
    };
  } catch (error) {
    console.error('[Brevo API] Error sending SMS:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred while sending SMS'
    };
  }
}

export async function sendOtpSms(phone, otp) {
  const message = `Your trap. verification code is: ${otp}. Valid for 10 minutes only. Reply STOP to opt out.`;
  return sendSms(phone, message);
}

export async function updateContactStage(email, stage, guestInfo, lastStageDate = new Date()) {
  if (!guestInfo || !guestInfo.guestId || !guestInfo.fullName) {
    console.error('[Brevo API] updateContactStage: guestInfo with guestId and fullName is required. Aborting attribute update.');
    return { success: false, message: 'Missing guestId or fullName for Brevo attribute update.' };
  }

  const formattedDate = lastStageDate.toISOString();
  
  const attributes = {
    STAGE: stage, 
    LAST_STAGE_UPDATE: formattedDate, 
    GUEST_ID: guestInfo.guestId, 
    FULL_NAME: guestInfo.fullName, 
    FIRST_NAME: guestInfo.fullName.split(' ')[0] 
  };
  
  if (stage === 2 || stage === 3) {
    const visitTypeForLink = stage === 2 ? 'icey-margarita' : 'free-cocktail';
    const token = btoa(`${guestInfo.guestId}|${guestInfo.fullName}`);
    attributes.COUPON_LINK_PATH = `/confirm/${token}?type=${visitTypeForLink}`;
    attributes.VISIT_TYPE_FOR_COUPON = visitTypeForLink;
    attributes.REVIEW_LINK = "https://g.co/kgs/RFM6TGv"; 
  } else {
    attributes.COUPON_LINK_PATH = null; 
    attributes.VISIT_TYPE_FOR_COUPON = null;
    // If STAGE is now 4 (completed), REVIEW_LINK might have already been sent or could be cleared.
    // For simplicity, we are not clearing REVIEW_LINK here explicitly if stage is not 2 or 3.
    // It will be cleared by `completeFunnel` if that path is taken.
  }
  
  return updateContact(email, attributes);
}

export async function optOutSms(email) {
  return updateContact(email, { SMS_OPT_OUT: true });
}

export async function optOutMarketing(email) {
  return updateContact(email, { MARKETING_CONSENT: false });
}

export async function completeFunnel(email, completionDate = new Date()) {
  console.log(`[Brevo API] Marking funnel as complete for ${email}. Setting STAGE to 4.`);
  // We assume GUEST_ID and FULL_NAME are already on the contact from previous updates.
  // If not, you might need to pass them to completeFunnel and include them here.
  return updateContact(email, {
    FUNNEL_COMPLETED: true, 
    COMPLETION_DATE: completionDate.toISOString(), 
    STAGE: 4, // Explicitly set Brevo STAGE to 4
    COUPON_LINK_PATH: null, 
    VISIT_TYPE_FOR_COUPON: null,
    REVIEW_LINK: null // Clear review link as well, or set a "final review" link
  });
}

export async function sendFinalThanksEmail(guestEmail, guestName) {
  console.log('[Brevo API] Attempting to send final thanks email to:', guestEmail);
  return sendTransactionalEmail(
    EmailTemplates.FINAL_THANKS,
    { email: guestEmail, name: guestName },
    {
      FIRST_NAME: guestName ? guestName.split(' ')[0] : 'Valued Customer',
      REVIEW_LINK: "https://g.co/kgs/RFM6TGv" 
    }
  );
}

================
File: src/api/supabase.js
================
// src/api/supabase.js
import { createClient } from '@supabase/supabase-js';

// Initialize Supabase client with env variables
const supabaseUrl = process.env.REACT_APP_SUPABASE_URL || import.meta.env?.VITE_SUPABASE_URL;
const supabaseKey = process.env.REACT_APP_SUPABASE_ANON_KEY || import.meta.env?.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.warn('Supabase configuration missing. Check your environment variables.');
}

export const supabase = createClient(supabaseUrl || '', supabaseKey || '');

// Guest Signup - Landing Page (Stage 0)
export async function signupLead(email, dob) {
  try {
    const formattedDob = dob instanceof Date ? dob.toISOString().split('T')[0] : dob;
    const { data, error } = await supabase.rpc('signup_lead', {
      p_email: email,
      p_dob: formattedDob
    });
    
    if (error) throw error;
    // RPC returns { success, guest_id, new_signup, message }
    // Your original return structure was fine, ensuring all expected fields are passed.
    return {
      success: data.success, 
      guest_id: data.guest_id, 
      new_signup: data.new_signup, 
      message: data.message 
    };
  } catch (error) {
    console.error('Error signing up lead:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred while signing up.'
    };
  }
}

// Send OTP for phone verification
export async function sendOtp(guestId, phone) {
  try {
    // Client-side formatting is good for consistency before sending to RPC
    const formattedPhone = phone.startsWith('+')
      ? phone
      : phone.startsWith('0')
        ? `+61${phone.substring(1)}`
        : `+61${phone}`; // Assumes Australian numbers if not starting with + or 0
        
    const { data, error } = await supabase.rpc('send_otp', {
      p_guest_id: guestId, 
      p_phone: formattedPhone // Send the client-formatted phone
    });
    
    if (error) throw error;
    // RPC returns { success, otp, expires_at, message }
    return {
      success: data.success,
      otp: data.otp, 
      expires_at: data.expires_at,
      message: data.message 
    };
  } catch (error) {  
    console.error('Error sending OTP:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred while sending OTP.'
    };
  }
}

// Verify OTP and complete voucher claim (Stage 1)
export async function verifyOtp(guestId, otp, fullName) {
  try {
    const { data, error } = await supabase.rpc('verify_otp', {
      p_guest_id: guestId,
      p_otp: otp, // RPC expects text
      p_full_name: fullName
    });
    
    if (error) throw error;
    // RPC returns { success, message, guest_id, full_name, email }
    return { 
      success: data.success,
      email: data.email,          
      guest_id: data.guest_id,    
      full_name: data.full_name,  
      message: data.message       
    };
  } catch (error) {
    console.error('Error verifying OTP:', error);
    return { 
      success: false, 
      message: error.message || 'An unexpected error occurred during OTP verification.' 
    };
  }
}

// Confirm visit by bartender
export async function confirmVisit(guestId, expectedVisitNumber) {
  console.log('[supabase.js] Calling confirmVisit RPC with guestId:', guestId, 'expectedVisitNumber:', expectedVisitNumber);

  if (!guestId || typeof guestId !== 'string' || guestId.trim() === '') {
    console.error('[supabase.js] confirmVisit: Invalid guestId provided.');
    return { success: false, message: 'Invalid guest ID provided.' };
  }
  if (typeof expectedVisitNumber !== 'number') {
    console.error('[supabase.js] confirmVisit: Invalid expectedVisitNumber provided.');
    return { success: false, message: 'Invalid expected visit number provided.' };
  }

  try {
    const { data, error } = await supabase.rpc('confirm_visit', {
      p_guest_id: guestId,
      p_expected_visit_number: expectedVisitNumber
    });
    
    if (error) throw error;
    // RPC returns { success, message, email, visit_number, stage, guest_id, full_name }
    return { 
      success: data.success,      
      message: data.message,      
      email: data.email,                 
      stage: data.stage,          
      visit_number: data.visit_number, 
      guest_id: data.guest_id,    
      full_name: data.full_name   
    };
  } catch (error) {
    console.error('[supabase.js] Error in confirmVisit RPC call:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred during visit confirmation.',
      email: null, stage: null, visit_number: null, guest_id: guestId, full_name: null // Keep returning structure
    };
  }
}

// Get funnel statistics for admin dashboard using the RPC
export async function getFunnelStats( /* Potentially add startDate, endDate if implementing time filter here later */ ) {
  try {
    // Call the RPC function that aggregates stats from the funnel_stats_overview view
    const { data, error } = await supabase.rpc('get_funnel_stats_data'); 
    
    if (error) {
        console.error('Error fetching funnel stats via RPC:', error);
        throw error; // Let AdminPage catch and display error
    }
    
    // RPC 'get_funnel_stats_data' should return an array of objects:
    // [{ stage, stage_name, count, conversion_rate (from_previous_stage) }, ...]
    // Ensure the keys match what FunnelStats.jsx expects (e.g., `conversion_rate`).
    // The RPC `get_funnel_stats_data` in your schema.sql already aliases `conversion_from_previous_stage` to `conversion_rate`.
    return data || []; 
  } catch (error) {
    console.error('Error processing funnel stats:', error);
    // Return a default structure on error to prevent AdminPage from crashing
    return [
      { stage: 0, stage_name: 'Leads (Signed Up)', count: 0, conversion_rate: 0 },
      { stage: 1, stage_name: 'Voucher Claimed (Spicy Marg)', count: 0, conversion_rate: 0 },
      { stage: 2, stage_name: '1st Visit (Spicy Marg Redeemed)', count: 0, conversion_rate: 0 },
      { stage: 3, stage_name: '2nd Visit (Icey Marg Redeemed)', count: 0, conversion_rate: 0 },
      { stage: 4, stage_name: '3rd Visit (Funnel Completed)', count: 0, conversion_rate: 0 }
    ];
  }
}

// Get monthly metrics for admin dashboard
export async function getMonthlyMetrics() {
  try {
    const { data, error } = await supabase
      .from('monthly_metrics')
      .select('*') // Selects all columns, including the new ones
      .order('month', { ascending: false });
    
    if (error) throw error;
    return data || [];
  } catch (error) {
    console.error('Error fetching monthly metrics:', error);
    return [];
  }
}

// Update monthly metrics
export async function updateMonthlyMetrics(metricData) {
  try {
    console.log("Updating/inserting monthly metrics with data:", metricData);
    const { data, error } = await supabase
      .from('monthly_metrics')
      .upsert(metricData, { onConflict: 'month' }); 
    
    if (error) throw error;
    return { success: true, data };
  } catch (error) {
    console.error('Error updating monthly metrics:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred while updating metrics.'
    };
  }
}

export async function getGuestStatusById(guestId) {
  try {
    const { data, error } = await supabase.rpc('get_guest_status_by_id', {
      p_guest_id: guestId
    });
    if (error) throw error;
    // RPC returns { success, guest: { guestId, fullName, phone, stage, email } }
    return data; 
  } catch (error) {
    console.error('Error fetching guest status by ID:', error);
    return { success: false, message: error.message || 'An unexpected error occurred while fetching guest status.' };
  }
}

// Delete monthly metrics
export async function deleteMonthlyMetrics(month) {
  try {
    console.log("Attempting to delete metrics for month:", month);
    // Check if record exists (optional, delete is idempotent but good for user feedback)
    // const { data: checkData, error: checkError } = await supabase
    //   .from('monthly_metrics')
    //   .select('month')
    //   .eq('month', month)
    //   .maybeSingle(); // Use maybeSingle to not error if not found

    // if (checkError && checkError.code !== 'PGRST116') { // PGRST116 is " بالضبط صف واحد لم يتم إرجاعه بواسطة الاستعلام " / "Exactly one row not returned by query"
    //   throw checkError;
    // }
    // if (!checkData) {
    //   console.warn(`No metrics found for month: ${month} to delete.`);
    //   return { success: false, message: 'No metrics found for the selected month to delete.' };
    // }
    
    const { error } = await supabase
      .from('monthly_metrics')
      .delete()
      .eq('month', month);
    
    if (error) {
      console.error('Supabase delete error for monthly_metrics:', error);
      throw error;
    }
    
    console.log("Metrics deleted successfully for month:", month);
    return { success: true };
  } catch (error) {
    console.error('Error deleting monthly metrics:', error);
    return {
      success: false,
      message: error.message || 'An unexpected error occurred while deleting metrics.'
    };
  }
}

================
File: src/components/admin/FunnelStats.css
================
/* Funnel stats styling */
.funnel-container {
    background-color: #121212;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }
  
  .funnel-title {
    color: white;
    font-size: 1.3rem;
    margin-bottom: 15px;
    font-weight: 600;
    text-align: center;
    font-family: 'Playfair Display', serif;
  }
  
  .funnel-chart {
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }
  
  .funnel-summary {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 15px;
    margin-bottom: 20px;
  }
  
  @media (min-width: 768px) {
    .funnel-summary {
      grid-template-columns: repeat(3, 1fr);
    }
  }
  
  .summary-card {
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .summary-title {
    font-size: 0.9rem;
    color: #aaa;
    margin-bottom: 8px;
    font-weight: 500;
  }
  
  .summary-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #ff007f;
    margin-bottom: 0;
  }
  
  .funnel-breakdown {
    margin-top: 25px;
  }
  
  .breakdown-title {
    color: white;
    font-size: 1.1rem;
    margin-bottom: 15px;
    font-weight: 600;
    font-family: 'Playfair Display', serif;
  }
  
  .stage-item {
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
  }
  
  .stage-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .stage-name {
    color: white;
    font-weight: 600;
  }
  
  .stage-count {
    color: #aaa;
  }
  
  .progress-bar-container {
    width: 100%;
    height: 12px;
    background-color: #2a2a2a;
    border-radius: 10px;
    overflow: hidden;
  }
  
  .progress-bar {
    height: 100%;
    background-color: #ff007f;
    border-radius: 10px;
    min-width: 15px;
    transition: width 0.5s ease;
  }
  
  .stage-conversion {
    text-align: right;
    font-size: 0.85rem;
    color: #aaa;
    margin-top: 5px;
  }

================
File: src/components/admin/FunnelStats.jsx
================
import React, { useEffect, useState } from 'react';
import { Bar } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend
} from 'chart.js';
import './FunnelStats.css'; // Import the new CSS

// Register ChartJS components
ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  Title,
  Tooltip,
  Legend
);

const FunnelStats = ({ stats }) => {
  const [chartData, setChartData] = useState(null);
  
  useEffect(() => {
    if (stats && stats.length > 0) {
      // Create the data for the chart
      const labels = stats.map(stage => stage.stage_name);
      const data = stats.map(stage => stage.count);
      
      setChartData({
        labels: labels,
        datasets: [
          {
            label: 'Number of Users',
            data: data,
            backgroundColor: [
              'rgba(255, 0, 127, 0.9)',
              'rgba(255, 0, 127, 0.7)',
              'rgba(255, 0, 127, 0.5)',
              'rgba(255, 0, 127, 0.3)'
            ],
            borderColor: [
              'rgba(255, 0, 127, 1)',
            ],
            borderWidth: 1,
            borderRadius: 6,
            hoverBackgroundColor: 'rgba(255, 0, 127, 1)',
          }
        ]
      });
    }
  }, [stats]);

  // Calculate overall conversion rate from stage 0 to final stage
  const calculateOverallConversion = () => {
    if (!stats || stats.length === 0) return 0;
    
    const stage0 = stats.find(s => s.stage === 0);
    const finalStage = stats.find(s => s.stage === stats.length - 1);
    
    if (!stage0 || !finalStage || stage0.count === 0) {
      return 0;
    }
    
    return (finalStage.count / stage0.count * 100).toFixed(2);
  };
  
  if (!stats || stats.length === 0) {
    return (
      <div className="funnel-container">
        <p className="text-gray-400 text-center">No funnel data available yet</p>
      </div>
    );
  }
  
  const overallConversion = calculateOverallConversion();
  
  // Chart options
  const chartOptions = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
      legend: {
        display: false,
      },
      title: {
        display: true,
        text: 'Funnel Conversion',
        color: 'white',
        font: {
          size: 18,
          family: "'Playfair Display', serif",
          weight: '600'
        },
        padding: {
          bottom: 20
        }
      },
      tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.8)',
        titleColor: 'white',
        bodyColor: 'white',
        borderColor: 'rgba(255, 255, 255, 0.2)',
        borderWidth: 1,
        displayColors: false,
        padding: 12,
        callbacks: {
          afterLabel: function(context) {
            const index = context.dataIndex;
            return `Conversion rate: ${stats[index].conversion_rate || 0}%`;
          }
        }
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        grid: {
          color: 'rgba(255, 255, 255, 0.1)',
          drawBorder: false,
        },
        ticks: {
          color: 'rgba(255, 255, 255, 0.8)'
        },
        title: {
          display: true,
          text: 'Number of Users',
          color: 'rgba(255, 255, 255, 0.8)',
          font: {
            size: 12,
            weight: '500'
          }
        }
      },
      x: {
        grid: {
          display: false,
          drawBorder: false,
        },
        ticks: {
          color: 'rgba(255, 255, 255, 0.8)',
        }
      }
    }
  };
  
  return (
    <div className="funnel-container">
      <div className="funnel-chart">
        {chartData && (
          <Bar 
            data={chartData}
            options={chartOptions}
          />
        )}
      </div>
      
      <div className="funnel-summary">
        <div className="summary-card">
          <h4 className="summary-title">Total Leads</h4>
          <div className="summary-value">{stats[0]?.count || 0}</div>
        </div>
        
        <div className="summary-card">
          <h4 className="summary-title">Overall Conversion</h4>
          <div className="summary-value">{overallConversion}%</div>
        </div>
        
        <div className="summary-card">
          <h4 className="summary-title">First Visit Rate</h4>
          <div className="summary-value">
            {stats.find(s => s.stage === 2)?.conversion_rate || 0}%
          </div>
        </div>
      </div>
      
      <div className="funnel-breakdown">
        <h4 className="breakdown-title">Funnel Breakdown</h4>
        <div className="stages-container">
          {stats.map((stage, index) => (
            <div key={stage.stage} className="stage-item">
              <div className="stage-header">
                <div className="stage-name">{stage.stage_name}</div>
                <div className="stage-count">{stage.count} users</div>
              </div>
              <div className="progress-bar-container">
                <div 
                  className="progress-bar" 
                  style={{ width: `${Math.max(5, (stage.count / stats[0].count) * 100)}%` }}
                ></div>
              </div>
              {index > 0 && (
                <div className="stage-conversion">
                  {stage.conversion_rate}% from previous stage
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default FunnelStats;

================
File: src/components/admin/MetricsDashboard.css
================
/* Admin dashboard chart styling */
.chart-container {
    background-color: #121212;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }
  
  .chart-title {
    color: white;
    font-size: 1.3rem;
    margin-bottom: 15px;
    font-weight: 600;
    text-align: center;
    font-family: 'Playfair Display', serif;
  }
  
  .metrics-summary {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 25px;
  }
  
  @media (min-width: 768px) {
    .metrics-summary {
      grid-template-columns: repeat(4, 1fr);
    }
  }
  
  .metric-card {
    background-color: #1a1a1a;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .metric-title {
    font-size: 0.9rem;
    color: #aaa;
    margin-bottom: 8px;
    font-weight: 500;
  }
  
  .metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0;
  }
  
  .metric-revenue .metric-value {
    color: #45bbff;
  }
  
  .metric-ad-spend .metric-value {
    color: #ff4d6d;
  }
  
  .metric-cogs .metric-value {
    color: #ffbc42;
  }
  
  .metric-profit .metric-value {
    color: #42f5b3;
  }
  
  .metric-profit.negative .metric-value {
    color: #ff4d6d;
  }
  
  .roi-analysis {
    background-color: #1a1a1a;
    border-radius: 12px;
    padding: 20px;
    margin-top: 25px;
  }
  
  .roi-title {
    color: white;
    font-size: 1.1rem;
    margin-bottom: 15px;
    font-weight: 600;
    font-family: 'Playfair Display', serif;
  }
  
  .roi-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  @media (min-width: 768px) {
    .roi-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  .roi-item {
    margin-bottom: 10px;
  }
  
  .roi-label {
    color: #aaa;
    font-size: 0.9rem;
    margin-right: 8px;
  }
  
  .roi-value {
    color: white;
    font-weight: 500;
  }
  
  .roi-value.highlight {
    color: #42f5b3;
    font-weight: 700;
  }
  
  /* Chart.js Custom Styles */
  :root {
    --chart-grid-color: rgba(255, 255, 255, 0.1);
    --chart-text-color: rgba(255, 255, 255, 0.8);
    --revenue-color: #45bbff;
    --ad-spend-color: #ff4d6d;
    --profit-color: #42f5b3;
    --loss-color: #ff4d6d;
  }

================
File: src/components/admin/MetricsDashboard.jsx
================
import React from 'react';
import { Line } from 'react-chartjs-2';
import {
  Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend
} from 'chart.js';
import './MetricsDashboard.css';

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend);

const MetricsDashboard = ({ metrics }) => {
  const formatCurrency = (amount, hideZero = false) => {
    const val = parseFloat(amount);
    if (hideZero && val === 0 && amount !== null) return '-'; // Allow explicit nulls to be $0.00
    return `$${(val || 0).toFixed(2)}`;
  };
  const formatPercentage = (value) => `${(parseFloat(value) || 0).toFixed(2)}%`;
  const formatNumber = (num, hideZero = false) => {
    const val = parseFloat(num);
     if (hideZero && val === 0 && num !== null) return '-';
    return (val || 0).toLocaleString();
  };

  const sortedMetrics = [...metrics].sort((a, b) => new Date(a.month) - new Date(b.month));

  const monthlyChartData = sortedMetrics.map(m => {
    const adSpend = parseFloat(m.stage0_ad_spend || 0);
    const revenue = parseFloat(m.total_revenue_from_funnel_this_month || 0);
    const cogs1 = parseFloat(m.stage1_cogs || 0);
    const smsCost = parseFloat(m.stage1_sms_cost || 0); // Changed from stage2_sms_cost
    const cogs2 = parseFloat(m.stage2_cogs || 0); // Added
    const cogs3 = parseFloat(m.stage3_cogs || 0);
    const profit = revenue - adSpend - cogs1 - smsCost - cogs2 - cogs3;
    return {
      month: new Date(m.month + 'T00:00:00').toLocaleDateString('en-AU', { month: 'short', year: 'numeric' }),
      adSpend,
      revenue,
      profit,
      // For derived metrics per month if needed for tooltips or other charts
      ctr: (parseFloat(m.total_ad_clicks || 0) / parseFloat(m.total_ad_impressions || 1)) * 100,
      cpc: parseFloat(m.stage0_ad_spend || 0) / parseFloat(m.total_ad_clicks || 1),
      landingPageConv: (parseFloat(m.new_leads_generated_this_month || 0) / parseFloat(m.total_ad_clicks || 1)) * 100,
    };
  });

  const chartData = {
    labels: monthlyChartData.map(d => d.month),
    datasets: [
      {
        label: 'Funnel Revenue',
        data: monthlyChartData.map(d => d.revenue),
        borderColor: 'var(--revenue-color)', backgroundColor: 'rgba(69, 187, 255, 0.2)',
        tension: 0.3, borderWidth: 2, pointRadius: 4,
      },
      {
        label: 'Ad Spend',
        data: monthlyChartData.map(d => d.adSpend),
        borderColor: 'var(--ad-spend-color)', backgroundColor: 'rgba(255, 77, 109, 0.2)',
        tension: 0.3, borderWidth: 2, pointRadius: 4,
      },
      {
        label: 'Funnel Profit',
        data: monthlyChartData.map(d => d.profit),
        borderColor: 'var(--profit-color)', backgroundColor: 'rgba(66, 245, 179, 0.2)',
        tension: 0.3, borderWidth: 2, pointRadius: 4,
      }
    ]
  };

  const chartOptions = { /* ... your existing chartOptions ... */
    responsive: true, maintainAspectRatio: true,
        scales: {
            y: { beginAtZero: true, grid: { color: 'var(--chart-grid-color)' }, ticks: { color: 'var(--chart-text-color)', callback: (v) => formatCurrency(v) }, title: { display: true, text: 'Amount ($)', color: 'var(--chart-text-color)'}},
            x: { grid: { display: false }, ticks: { color: 'var(--chart-text-color)'}, title: { display: true, text: 'Month', color: 'var(--chart-text-color)'}}
        },
        plugins: {
            legend: { position: 'top', labels: { color: 'var(--chart-text-color)', usePointStyle: true, pointStyle: 'circle' }},
            title: { display: true, text: 'Monthly Financial Performance', color: 'white', font: { size: 18, family: "'Playfair Display', serif" }, padding: { bottom: 20 }},
            tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${formatCurrency(c.parsed.y)}`}}
        }
   };

  // Calculate aggregate totals and derived metrics
  const totals = metrics.reduce((acc, m) => {
    acc.impressions += parseFloat(m.total_ad_impressions || 0);
    acc.clicks += parseFloat(m.total_ad_clicks || 0);
    acc.adSpend += parseFloat(m.stage0_ad_spend || 0);
    acc.newLeads += parseFloat(m.new_leads_generated_this_month || 0);
    acc.vouchersClaimed += parseFloat(m.vouchers_claimed_this_month || 0);
    acc.firstVisits += parseFloat(m.first_visits_this_month || 0);
    acc.secondVisits += parseFloat(m.second_visits_this_month || 0);
    acc.thirdVisits += parseFloat(m.third_visits_this_month || 0);
    acc.cogs1 += parseFloat(m.stage1_cogs || 0);
    acc.smsCost += parseFloat(m.stage1_sms_cost || 0);
    acc.cogs2 += parseFloat(m.stage2_cogs || 0);
    acc.cogs3 += parseFloat(m.stage3_cogs || 0);
    acc.funnelRevenue += parseFloat(m.total_revenue_from_funnel_this_month || 0);
    return acc;
  }, { impressions: 0, clicks: 0, adSpend: 0, newLeads: 0, vouchersClaimed: 0, firstVisits: 0, secondVisits: 0, thirdVisits: 0, cogs1: 0, smsCost: 0, cogs2: 0, cogs3: 0, funnelRevenue: 0 });

  const totalCogs = totals.cogs1 + totals.smsCost + totals.cogs2 + totals.cogs3;
  const totalFunnelProfit = totals.funnelRevenue - totals.adSpend - totalCogs;

  const derived = {
    ctr: totals.impressions > 0 ? (totals.clicks / totals.impressions) * 100 : 0,
    cpc: totals.clicks > 0 ? totals.adSpend / totals.clicks : 0,
    landingPageConvRate: totals.clicks > 0 ? (totals.newLeads / totals.clicks) * 100 : 0,
    cpl: totals.newLeads > 0 ? totals.adSpend / totals.newLeads : 0,
    leadToClaimRate: totals.newLeads > 0 ? (totals.vouchersClaimed / totals.newLeads) * 100 : 0,
    claimTo1stVisitRate: totals.vouchersClaimed > 0 ? (totals.firstVisits / totals.vouchersClaimed) * 100 : 0,
    firstTo2ndVisitRate: totals.firstVisits > 0 ? (totals.secondVisits / totals.firstVisits) * 100 : 0,
    secondTo3rdVisitRate: totals.secondVisits > 0 ? (totals.thirdVisits / totals.secondVisits) * 100 : 0,
    overallFunnelCompletionRate: totals.newLeads > 0 ? (totals.thirdVisits / totals.newLeads) * 100 : 0,
    cpa: totals.thirdVisits > 0 ? (totals.adSpend + totalCogs) / totals.thirdVisits : 0, // Cost per completed funnel
    avgRevenuePerLead: totals.newLeads > 0 ? totals.funnelRevenue / totals.newLeads : 0,
    profitMargin: totals.funnelRevenue > 0 ? (totalFunnelProfit / totals.funnelRevenue) * 100 : 0,
    roiOnAdSpend: totals.adSpend > 0 ? (totalFunnelProfit / totals.adSpend) * 100 : 0,
  };

  if (!metrics || metrics.length === 0) {
    return <div className="chart-container"><p className="text-gray-400 text-center">No monthly metrics data available yet.</p></div>;
  }

  return (
    <div className="dashboard-container">
      <div className="chart-container">
        <Line data={chartData} options={chartOptions} />
      </div>

      <div className="metrics-summary">
        <div className="metric-card metric-revenue"><h4 className="metric-title">Total Funnel Revenue</h4><div className="metric-value">{formatCurrency(totals.funnelRevenue)}</div></div>
        <div className="metric-card metric-ad-spend"><h4 className="metric-title">Total Ad Spend</h4><div className="metric-value">{formatCurrency(totals.adSpend)}</div></div>
        <div className="metric-card metric-cogs"><h4 className="metric-title">Total Funnel COGS</h4><div className="metric-value">{formatCurrency(totalCogs)}</div></div>
        <div className={`metric-card metric-profit ${totalFunnelProfit >= 0 ? '' : 'negative'}`}><h4 className="metric-title">Total Funnel Profit</h4><div className="metric-value">{formatCurrency(totalFunnelProfit)}</div></div>
      </div>

      <div className="roi-analysis"> {/* Using roi-analysis class for section styling */}
        <h3 className="roi-title">Key Performance Indicators (Overall)</h3>
        <div className="roi-grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"> {/* Adjusted grid for more items */}
          <div className="metric-card"><h4 className="metric-title">Ad Impressions</h4><div className="metric-value">{formatNumber(totals.impressions)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Ad Clicks</h4><div className="metric-value">{formatNumber(totals.clicks)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Click-Through Rate (CTR)</h4><div className="metric-value">{formatPercentage(derived.ctr)}</div></div>
          
          <div className="metric-card"><h4 className="metric-title">Cost Per Click (CPC)</h4><div className="metric-value">{formatCurrency(derived.cpc)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Landing Page Conv. Rate</h4><div className="metric-value">{formatPercentage(derived.landingPageConvRate)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Cost Per Lead (CPL)</h4><div className="metric-value">{formatCurrency(derived.cpl)}</div></div>

          <div className="metric-card"><h4 className="metric-title">Leads Generated</h4><div className="metric-value">{formatNumber(totals.newLeads)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Vouchers Claimed</h4><div className="metric-value">{formatNumber(totals.vouchersClaimed)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Funnel Completions (3rd Visits)</h4><div className="metric-value">{formatNumber(totals.thirdVisits)}</div></div>
          
          <div className="metric-card"><h4 className="metric-title">Overall Funnel Completion Rate</h4><div className="metric-value">{formatPercentage(derived.overallFunnelCompletionRate)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Cost Per Acquisition (CPA - Funnel)</h4><div className="metric-value">{formatCurrency(derived.cpa)}</div></div>
          <div className="metric-card"><h4 className="metric-title">Avg. Revenue Per Lead</h4><div className="metric-value">{formatCurrency(derived.avgRevenuePerLead)}</div></div>
          
          <div className="metric-card"><h4 className="metric-title">Funnel Profit Margin</h4><div className="metric-value">{formatPercentage(derived.profitMargin)}</div></div>
          <div className="metric-card"><h4 className="metric-title">ROI on Ad Spend</h4><div className="metric-value highlight">{formatPercentage(derived.roiOnAdSpend)}</div></div>
        </div>
      </div>

      <div className="roi-analysis" style={{marginTop: '25px'}}>
        <h3 className="roi-title">Funnel Stage Conversion Rates (Overall)</h3>
         <div className="roi-grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div className="metric-card"><h4 className="metric-title">Lead to Voucher Claim Rate</h4><div className="metric-value">{formatPercentage(derived.leadToClaimRate)}</div></div>
            <div className="metric-card"><h4 className="metric-title">Claim to 1st Visit Rate</h4><div className="metric-value">{formatPercentage(derived.claimTo1stVisitRate)}</div></div>
            <div className="metric-card"><h4 className="metric-title">1st Visit to 2nd Visit Rate</h4><div className="metric-value">{formatPercentage(derived.firstTo2ndVisitRate)}</div></div>
            <div className="metric-card"><h4 className="metric-title">2nd Visit to 3rd Visit Rate</h4><div className="metric-value">{formatPercentage(derived.secondTo3rdVisitRate)}</div></div>
        </div>
      </div>
    </div>
  );
};

export default MetricsDashboard;

================
File: src/components/admin/MetricsForm.css
================
.metrics-form-container h4 {
  margin-top: 1.5rem;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
  color: #ff007f;
  border-bottom: 1px solid #333;
  padding-bottom: 0.3rem;
}

.field-info-header {
  display: flex;
  align-items: center;
  margin-bottom: 0.3rem; /* Adjust as needed */
}

.field-info-header label {
  margin-bottom: 0; /* Override default label margin */
  margin-right: 8px;
}

.info-icon-button {
  background: none;
  border: none;
  color: #888; /* Lighter gray for info icon */
  cursor: pointer;
  font-size: 1.1em; /* Adjust size of info icon */
  padding: 0 5px; /* Add some padding around icon */
  line-height: 1;
}

.info-icon-button:hover {
  color: #ccc;
}

.field-info-note {
  font-size: 0.75em;
  color: #a0a0a0; /* Lighter gray for note text */
  margin-top: -0.2rem; /* Pull it closer to the label/icon */
  margin-bottom: 0.4rem;
  font-style: italic;
  padding-left: 25px; /* Indent note slightly if icon is present */
}


/* Modal for Note Editor */
.note-editor-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000; /* Ensure it's above other content */
}

.note-editor-modal-content {
  background-color: #1e1e1e; /* Dark background for modal */
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
  width: 90%;
  max-width: 500px;
  color: #fff; /* White text for modal content */
}

.note-editor-modal-content h4 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #ff007f; /* Accent color for modal title */
}

.note-editor-modal-content textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  background-color: #2a2a2a; /* Slightly lighter dark for textarea */
  border: 1px solid #444;
  border-radius: 4px;
  color: #fff; /* White text in textarea */
  font-size: 0.9rem;
  min-height: 80px;
}

================
File: src/components/admin/MetricsForm.jsx
================
import React, { useState, useEffect, Fragment } from 'react';
import Button from '../common/Button';
import Input from '../common/Input';
import './MetricsForm.css'; // Create this CSS file for modal styling

// Helper component for info icon and note editing
const FieldInfo = ({ fieldKey, fieldLabel, fieldNotes, onEditNote }) => {
  return (
    <div className="field-info-header">
      <label htmlFor={fieldKey}>{fieldLabel}</label>
      <button
        type="button"
        onClick={() => onEditNote(fieldKey, fieldNotes[fieldKey] || '')}
        className="info-icon-button"
        title={`Edit note for ${fieldLabel}`}
      >
        ⓘ {/* Unicode Info Icon */}
      </button>
      {fieldNotes[fieldKey] && (
        <p className="field-info-note"><em>Note: {fieldNotes[fieldKey]}</em></p>
      )}
    </div>
  );
};


export default function MetricsForm({ onSubmit, onCancel, existingMetrics }) {
  const initialFormData = {
    month: '', selectedMonth: '', selectedYear: '',
    total_ad_impressions: '', total_ad_clicks: '', stage0_ad_spend: '',
    new_leads_generated_this_month: '', vouchers_claimed_this_month: '',
    first_visits_this_month: '', second_visits_this_month: '', third_visits_this_month: '',
    stage1_cogs: '', stage2_cogs: '', stage3_cogs: '', /* stage1_sms_cost is calculated */
    total_revenue_from_funnel_this_month: '',
    notes: ''
  };

  const [formData, setFormData] = useState(initialFormData);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState('');
  const [existingMonths, setExistingMonths] = useState([]);

  // For info icon notes
  const [fieldNotes, setFieldNotes] = useState({});
  const [editingNoteFor, setEditingNoteFor] = useState(null); // fieldKey string
  const [currentNoteText, setCurrentNoteText] = useState('');

  useEffect(() => {
    if (existingMetrics && existingMetrics.length > 0) {
      setExistingMonths(existingMetrics.map(metric => metric.month));
    }
    const savedNotes = localStorage.getItem('metricFormNotes');
    if (savedNotes) {
      setFieldNotes(JSON.parse(savedNotes));
    }
  }, [existingMetrics]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  useEffect(() => {
    if (formData.selectedMonth && formData.selectedYear) {
      const monthNum = parseInt(formData.selectedMonth) + 1;
      const formattedMonth = monthNum < 10 ? `0${monthNum}` : monthNum;
      setFormData(prev => ({ ...prev, month: `${formData.selectedYear}-${formattedMonth}-01` }));
    }
  }, [formData.selectedMonth, formData.selectedYear]);

  const validateForm = () => {
    if (!formData.month) {
      setError('Please select both month and year.'); return false;
    }
    if (existingMonths.includes(formData.month)) {
      setError('Data for this month already exists. Edit it from the table or choose a different month.'); return false;
    }
    const numericFields = [
      'total_ad_impressions', 'total_ad_clicks', 'stage0_ad_spend',
      'new_leads_generated_this_month', 'vouchers_claimed_this_month',
      'first_visits_this_month', 'second_visits_this_month', 'third_visits_this_month',
      'stage1_cogs', 'stage2_cogs', 'stage3_cogs',
      'total_revenue_from_funnel_this_month'
    ];
    for (const field of numericFields) {
      if (formData[field] && isNaN(parseFloat(formData[field]))) {
        setError(`Please enter a valid number for ${field.replace(/_/g, ' ')}.`); return false;
      }
    }
    setError('');
    return true;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!validateForm()) return;
    setIsSubmitting(true);

    const calculatedSmsCost = (parseFloat(formData.vouchers_claimed_this_month) || 0) * 0.1091;

    const submissionData = {
      month: formData.month,
      total_ad_impressions: parseFloat(formData.total_ad_impressions) || 0,
      total_ad_clicks: parseFloat(formData.total_ad_clicks) || 0,
      stage0_ad_spend: parseFloat(formData.stage0_ad_spend) || 0,
      new_leads_generated_this_month: parseFloat(formData.new_leads_generated_this_month) || 0,
      vouchers_claimed_this_month: parseFloat(formData.vouchers_claimed_this_month) || 0,
      first_visits_this_month: parseFloat(formData.first_visits_this_month) || 0,
      second_visits_this_month: parseFloat(formData.second_visits_this_month) || 0,
      third_visits_this_month: parseFloat(formData.third_visits_this_month) || 0,
      stage1_cogs: parseFloat(formData.stage1_cogs) || 0,
      stage1_sms_cost: calculatedSmsCost.toFixed(2), // Store as fixed 2 decimal places
      stage2_cogs: parseFloat(formData.stage2_cogs) || 0,
      stage3_cogs: parseFloat(formData.stage3_cogs) || 0,
      total_revenue_from_funnel_this_month: parseFloat(formData.total_revenue_from_funnel_this_month) || 0,
      notes: formData.notes
    };

    try {
      const success = await onSubmit(submissionData);
      if (success) {
        setFormData(initialFormData); // Reset form on successful submission
      }
    } catch (err) {
      console.error('Error submitting metrics:', err);
      setError('An unexpected error occurred during submission.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const getYears = () => {
    const years = [];
    for (let i = 2025; i <= 2030; i++) years.push(i);
    return years.sort((a, b) => b - a);
  };
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

  // Note editing functions
  const handleEditNote = (fieldKey, currentText) => {
    setEditingNoteFor(fieldKey);
    setCurrentNoteText(currentText);
  };

  const handleSaveNote = () => {
    if (editingNoteFor) {
      const updatedNotes = { ...fieldNotes, [editingNoteFor]: currentNoteText };
      setFieldNotes(updatedNotes);
      localStorage.setItem('metricFormNotes', JSON.stringify(updatedNotes));
    }
    setEditingNoteFor(null);
    setCurrentNoteText('');
  };

  const renderFieldWithInfo = (fieldKey, label, type = "number", placeholder = "0", step = "1") => (
    <div className="form-group">
      <FieldInfo fieldKey={fieldKey} fieldLabel={label} fieldNotes={fieldNotes} onEditNote={handleEditNote} />
      <Input
        id={fieldKey} name={fieldKey} type={type} min="0" step={step}
        value={formData[fieldKey]} onChange={handleChange} placeholder={placeholder}
      />
    </div>
  );


  return (
    <div className="metrics-form-container">
      <h3>Add/Edit Monthly Metrics</h3>
      {error && <div className="error-message">{error}</div>}
      <form onSubmit={handleSubmit}>
        {/* Month/Year Selection */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div className="form-group">
            <FieldInfo fieldKey="month_selection" fieldLabel="Month & Year" fieldNotes={fieldNotes} onEditNote={handleEditNote} />
            <select id="selectedMonth" name="selectedMonth" value={formData.selectedMonth} onChange={handleChange} required>
              <option value="">Select Month</option>
              {months.map((m, i) => <option key={i} value={i}>{m}</option>)}
            </select>
          </div>
          <div className="form-group">
            <label htmlFor="selectedYear" style={{opacity: 0}}>Year</label> {/* Hidden label for spacing */}
            <select id="selectedYear" name="selectedYear" value={formData.selectedYear} onChange={handleChange} required>
              <option value="">Select Year</option>
              {getYears().map(y => <option key={y} value={y}>{y}</option>)}
            </select>
          </div>
        </div>

        <h4>Pre-Funnel Metrics</h4>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {renderFieldWithInfo("total_ad_impressions", "Total Ad Impressions")}
          {renderFieldWithInfo("total_ad_clicks", "Total Ad Clicks")}
          {renderFieldWithInfo("stage0_ad_spend", "Ad Spend ($)", "number", "0.00", "0.01")}
        </div>

        <h4>In-Funnel Counts (Events this month)</h4>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {renderFieldWithInfo("new_leads_generated_this_month", "New Leads Generated")}
          {renderFieldWithInfo("vouchers_claimed_this_month", "Vouchers Claimed (Spicy Marg)")}
          {renderFieldWithInfo("first_visits_this_month", "1st Visits (Spicy Marg Redeemed)")}
          {renderFieldWithInfo("second_visits_this_month", "2nd Visits (Icey Marg Redeemed)")}
          {renderFieldWithInfo("third_visits_this_month", "3rd Visits (Funnel Completed)")}
        </div>
        
        <h4>In-Funnel Costs & Revenue ($)</h4>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {renderFieldWithInfo("stage1_cogs", "Spicy Margarita COGS (1st Visit)", "number", "0.00", "0.01")}
          {renderFieldWithInfo("stage2_cogs", "Icey Margarita COGS (2nd Visit)", "number", "0.00", "0.01")}
          {renderFieldWithInfo("stage3_cogs", "House Cocktail COGS (3rd Visit)", "number", "0.00", "0.01")}
          <div className="form-group">
            <FieldInfo fieldKey="stage1_sms_cost_info" fieldLabel="SMS Cost (Auto-Calculated)" fieldNotes={fieldNotes} onEditNote={handleEditNote} />
            <Input
                type="text"
                value={`$${((parseFloat(formData.vouchers_claimed_this_month) || 0) * 0.1091).toFixed(2)}`}
                readOnly
                disabled
            />
            <p className="small-text">Based on {formData.vouchers_claimed_this_month || 0} vouchers claimed @ $0.1091 each.</p>
          </div>
          {renderFieldWithInfo("total_revenue_from_funnel_this_month", "Total Revenue from Funnel", "number", "0.00", "0.01")}
        </div>
        
        <div className="form-group mt-4">
          <FieldInfo fieldKey="general_notes" fieldLabel="General Notes for this month" fieldNotes={fieldNotes} onEditNote={handleEditNote} />
          <textarea id="notes" name="notes" value={formData.notes} onChange={handleChange} placeholder="Any observations..." rows="3"/>
        </div>

        <div className="flex justify-end gap-3 mt-6">
          <Button type="button" variant="secondary" onClick={onCancel} disabled={isSubmitting}>Cancel</Button>
          <Button type="submit" variant="primary" disabled={isSubmitting || !formData.month}>
            {isSubmitting ? 'Saving...' : 'Save Metrics'}
          </Button>
        </div>
      </form>

      {editingNoteFor && (
        <div className="note-editor-modal-overlay">
          <div className="note-editor-modal-content">
            <h4>Edit Note for: {editingNoteFor.replace(/_/g, ' ')}</h4>
            <textarea
              value={currentNoteText}
              onChange={(e) => setCurrentNoteText(e.target.value)}
              rows="4"
              style={{ width: '100%', marginBottom: '10px' }}
              autoFocus
            />
            <div style={{ textAlign: 'right' }}>
              <Button onClick={() => setEditingNoteFor(null)} variant="secondary" size="small" style={{ marginRight: '10px' }}>Cancel</Button>
              <Button onClick={handleSaveNote} variant="primary" size="small">Save Note</Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

================
File: src/components/admin/MetricsTable.css
================
/* Metrics table styling */
.metrics-table-container {
    background-color: #121212;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
  }
  
  .metrics-table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .table-title {
    color: white;
    font-size: 1.3rem;
    font-weight: 600;
    font-family: 'Playfair Display', serif;
  }
  
  .add-month-button {
    background-color: #ff007f;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .add-month-button:hover {
    background-color: #e1006f;
  }
  
  .table-wrapper {
    overflow-x: auto;
    margin-bottom: 15px;
  }
  
  .metrics-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    color: white;
  }
  
  .metrics-table th {
    background-color: #1a1a1a;
    text-align: left;
    padding: 12px 15px;
    font-weight: 600;
    font-size: 0.9rem;
    color: #aaa;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .metrics-table th:first-child {
    border-top-left-radius: 8px;
  }
  
  .metrics-table th:last-child {
    border-top-right-radius: 8px;
    text-align: right;
  }
  
  .metrics-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #2a2a2a;
    font-size: 0.95rem;
  }
  
  .metrics-table tr:hover td {
    background-color: #1e1e1e;
  }
  
  .metrics-table tr:last-child td:first-child {
    border-bottom-left-radius: 8px;
  }
  
  .metrics-table tr:last-child td:last-child {
    border-bottom-right-radius: 8px;
  }
  
  /* Column specific styles */
  .col-month {
    min-width: 120px;
  }
  
  .col-ad-spend,
  .col-cogs,
  .col-sms-cost {
    color: #ff4d6d;
    min-width: 90px;
  }
  
  .col-revenue {
    color: #45bbff;
    min-width: 90px;
  }
  
  .col-profit {
    font-weight: 600;
    min-width: 90px;
  }
  
  .col-profit.positive {
    color: #42f5b3;
  }
  
  .col-profit.negative {
    color: #ff4d6d;
  }
  
  .col-actions {
    text-align: right;
    min-width: 100px;
  }
  
  /* Table footer */
  .metrics-table tfoot td {
    background-color: #1a1a1a;
    font-weight: 600;
    border-bottom: none;
  }
  
  /* Action buttons */
  .action-buttons {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .remove-button {
    background-color: #333;
    color: white;
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .remove-button:hover {
    background-color: #444;
  }
  
  /* Confirmation actions */
  .confirm-actions {
    display: flex;
    gap: 6px;
    justify-content: flex-end;
  }
  
  .confirm-button {
    background-color: #ff3333;
    color: white;
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
  }
  
  .confirm-button:hover {
    background-color: #e60000;
  }
  
  .cancel-button {
    background-color: #333;
    color: white;
    padding: 6px 10px;
    border: none;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
  }
  
  .cancel-button:hover {
    background-color: #444;
  }
  
  /* Notes toggler */
  .notes-toggle {
    background: none;
    border: none;
    color: #45bbff;
    font-size: 0.8rem;
    text-decoration: underline;
    cursor: pointer;
    padding: 0;
    margin-left: 5px;
  }
  
  .notes-toggle:hover {
    color: #73ceff;
  }
  
  /* Notes section */
  .notes-section {
    background-color: #1e1e1e;
    padding: 12px 15px;
    border-left: 3px solid #45bbff;
    margin-bottom: 10px;
  }
  
  .notes-label {
    font-weight: 600;
    color: #aaa;
    margin-right: 5px;
  }
  
  .no-data-message {
    text-align: center;
    color: #aaa;
    padding: 30px 0;
  }

================
File: src/components/admin/MetricsTable.jsx
================
import React, { useState } from 'react';
import './MetricsTable.css'; // Ensure this CSS file exists and is styled

export default function MetricsTable({ metrics, onDeleteMetric }) {
  const [expandedNotes, setExpandedNotes] = useState(null);
  const [deleteConfirm, setDeleteConfirm] = useState(null);
  
  const formatCurrency = (amount, hideZero = false) => {
    const val = parseFloat(amount);
    if (hideZero && val === 0) return '-';
    return `$${(val || 0).toFixed(2)}`;
  };

  const formatNumber = (num, hideZero = false) => {
    const val = parseFloat(num);
    if (hideZero && val === 0) return '-';
    return (val || 0).toLocaleString();
  }
  
  const calculateProfit = (metric) => {
    const revenue = parseFloat(metric.total_revenue_from_funnel_this_month || 0);
    const adSpend = parseFloat(metric.stage0_ad_spend || 0);
    const cogs1 = parseFloat(metric.stage1_cogs || 0);
    const smsCost = parseFloat(metric.stage1_sms_cost || 0); // Uses stage1_sms_cost
    const cogs2 = parseFloat(metric.stage2_cogs || 0); // Added stage2_cogs
    const cogs3 = parseFloat(metric.stage3_cogs || 0);
    
    const profit = revenue - adSpend - cogs1 - smsCost - cogs2 - cogs3;
    return { value: profit, formatted: formatCurrency(profit) };
  };
  
  const formatDate = (dateStr) => {
    const date = new Date(dateStr + 'T00:00:00'); // Ensure it's treated as local, not UTC midnight
    return date.toLocaleDateString('en-AU', { month: 'long', year: 'numeric' });
  };
  
  const sortedMetrics = [...metrics].sort((a, b) => new Date(b.month) - new Date(a.month));
  
  const totals = metrics.reduce((acc, m) => {
    acc.total_ad_impressions += parseFloat(m.total_ad_impressions || 0);
    acc.total_ad_clicks += parseFloat(m.total_ad_clicks || 0);
    acc.stage0_ad_spend += parseFloat(m.stage0_ad_spend || 0);
    acc.new_leads_generated_this_month += parseFloat(m.new_leads_generated_this_month || 0);
    acc.vouchers_claimed_this_month += parseFloat(m.vouchers_claimed_this_month || 0);
    acc.first_visits_this_month += parseFloat(m.first_visits_this_month || 0);
    acc.second_visits_this_month += parseFloat(m.second_visits_this_month || 0);
    acc.third_visits_this_month += parseFloat(m.third_visits_this_month || 0);
    acc.stage1_cogs += parseFloat(m.stage1_cogs || 0);
    acc.stage1_sms_cost += parseFloat(m.stage1_sms_cost || 0);
    acc.stage2_cogs += parseFloat(m.stage2_cogs || 0);
    acc.stage3_cogs += parseFloat(m.stage3_cogs || 0);
    acc.total_revenue_from_funnel_this_month += parseFloat(m.total_revenue_from_funnel_this_month || 0);
    return acc;
  }, {
    total_ad_impressions: 0, total_ad_clicks: 0, stage0_ad_spend: 0,
    new_leads_generated_this_month: 0, vouchers_claimed_this_month: 0,
    first_visits_this_month: 0, second_visits_this_month: 0, third_visits_this_month: 0,
    stage1_cogs: 0, stage1_sms_cost: 0, stage2_cogs: 0, stage3_cogs: 0,
    total_revenue_from_funnel_this_month: 0
  });

  const totalProfit = totals.total_revenue_from_funnel_this_month - totals.stage0_ad_spend - totals.stage1_cogs - totals.stage1_sms_cost - totals.stage2_cogs - totals.stage3_cogs;

  if (!metrics || metrics.length === 0) {
    return (
      <div className="metrics-table-container">
        <p className="no-data-message">No monthly metrics data available yet.</p>
      </div>
    );
  }
  
  return (
    <div className="metrics-table-container">
      <div className="table-wrapper">
        <table className="metrics-table">
          <thead>
            <tr>
              <th className="col-month">Month</th>
              {/* Pre-Funnel */}
              <th>Ad Impr.</th>
              <th>Ad Clicks</th>
              <th className="col-ad-spend">Ad Spend</th>
              {/* In-Funnel Counts */}
              <th>New Leads</th>
              <th>Vouchers Claimed</th>
              <th>1st Visits</th>
              <th>2nd Visits</th>
              <th>3rd Visits</th>
              {/* Costs */}
              <th className="col-cogs">S1 COGS</th>
              <th className="col-sms-cost">SMS Cost</th>
              <th className="col-cogs">S2 COGS</th>
              <th className="col-cogs">S3 COGS</th>
              {/* Revenue & Profit */}
              <th className="col-revenue">Funnel Rev.</th>
              <th className="col-profit">Profit</th>
              <th className="col-actions">Actions</th>
            </tr>
          </thead>
          <tbody>
            {sortedMetrics.map((metric) => {
              const profit = calculateProfit(metric);
              const profitClass = profit.value >= 0 ? 'positive' : 'negative';
              const hasNotes = metric.notes && metric.notes.trim().length > 0;
              
              return (
                <React.Fragment key={metric.month}>
                  <tr>
                    <td className="col-month">
                      {formatDate(metric.month)}
                      {hasNotes && (
                        <button onClick={() => setExpandedNotes(expandedNotes === metric.month ? null : metric.month)} className="notes-toggle">
                          {expandedNotes === metric.month ? 'Hide notes' : 'Show notes'}
                        </button>
                      )}
                    </td>
                    {/* Pre-Funnel */}
                    <td>{formatNumber(metric.total_ad_impressions, true)}</td>
                    <td>{formatNumber(metric.total_ad_clicks, true)}</td>
                    <td className="col-ad-spend">{formatCurrency(metric.stage0_ad_spend, true)}</td>
                    {/* In-Funnel Counts */}
                    <td>{formatNumber(metric.new_leads_generated_this_month, true)}</td>
                    <td>{formatNumber(metric.vouchers_claimed_this_month, true)}</td>
                    <td>{formatNumber(metric.first_visits_this_month, true)}</td>
                    <td>{formatNumber(metric.second_visits_this_month, true)}</td>
                    <td>{formatNumber(metric.third_visits_this_month, true)}</td>
                    {/* Costs */}
                    <td className="col-cogs">{formatCurrency(metric.stage1_cogs, true)}</td>
                    <td className="col-sms-cost">{formatCurrency(metric.stage1_sms_cost, true)}</td>
                    <td className="col-cogs">{formatCurrency(metric.stage2_cogs, true)}</td>
                    <td className="col-cogs">{formatCurrency(metric.stage3_cogs, true)}</td>
                    {/* Revenue & Profit */}
                    <td className="col-revenue">{formatCurrency(metric.total_revenue_from_funnel_this_month, true)}</td>
                    <td className={`col-profit ${profitClass}`}>{profit.formatted}</td>
                    <td className="col-actions">
                      {deleteConfirm === metric.month ? (
                        <div className="confirm-actions">
                          <button onClick={() => { onDeleteMetric(metric.month); setDeleteConfirm(null); }} className="confirm-button">Delete</button>
                          <button onClick={() => setDeleteConfirm(null)} className="cancel-button">Cancel</button>
                        </div>
                      ) : (
                        <button onClick={() => setDeleteConfirm(metric.month)} className="remove-button">Remove</button>
                      )}
                    </td>
                  </tr>
                  {expandedNotes === metric.month && hasNotes && (
                    <tr>
                      <td colSpan="16"> {/* Adjust colSpan to match number of columns */}
                        <div className="notes-section"><span className="notes-label">Notes:</span> {metric.notes}</div>
                      </td>
                    </tr>
                  )}
                </React.Fragment>
              );
            })}
          </tbody>
          <tfoot>
            <tr>
              <td className="col-month">Total</td>
              <td>{formatNumber(totals.total_ad_impressions)}</td>
              <td>{formatNumber(totals.total_ad_clicks)}</td>
              <td className="col-ad-spend">{formatCurrency(totals.stage0_ad_spend)}</td>
              <td>{formatNumber(totals.new_leads_generated_this_month)}</td>
              <td>{formatNumber(totals.vouchers_claimed_this_month)}</td>
              <td>{formatNumber(totals.first_visits_this_month)}</td>
              <td>{formatNumber(totals.second_visits_this_month)}</td>
              <td>{formatNumber(totals.third_visits_this_month)}</td>
              <td className="col-cogs">{formatCurrency(totals.stage1_cogs)}</td>
              <td className="col-sms-cost">{formatCurrency(totals.stage1_sms_cost)}</td>
              <td className="col-cogs">{formatCurrency(totals.stage2_cogs)}</td>
              <td className="col-cogs">{formatCurrency(totals.stage3_cogs)}</td>
              <td className="col-revenue">{formatCurrency(totals.total_revenue_from_funnel_this_month)}</td>
              <td className={`col-profit ${totalProfit >= 0 ? 'positive' : 'negative'}`}>{formatCurrency(totalProfit)}</td>
              <td className="col-actions"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  );
}

================
File: src/components/common/Button.css
================
.button {
  font-family: 'Raleway', sans-serif;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Button variants */
.primary-button {
  background-color: #ff007f;
  color: white;
}

.primary-button:hover {
  background-color: #cc0066;
}

.secondary-button {
  background-color: #1a1a1a;
  color: #fff;
  border: 1px solid #333;
}

.secondary-button:hover {
  background-color: #252525;
}

.confirm-button {
  background-color: #00b300;
  color: white;
}

.confirm-button:hover {
  background-color: #009900;
}

.danger-button {
  background-color: #ff3333;
  color: white;
}

.danger-button:hover {
  background-color: #e60000;
}

.text-button {
  background-color: transparent;
  color: #ff007f;
  padding: 0;
  font-weight: 500;
  text-decoration: underline;
}

.text-button:hover {
  color: #cc0066;
}

/* Button sizes */
.small-button {
  padding: 8px 12px;
  font-size: 0.8rem;
}

.medium-button {
  padding: 12px 18px;
  font-size: 1rem;
}

.large-button {
  padding: 16px 24px;
  font-size: 1.1rem;
}

/* Disabled state */
.button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: none;
}

================
File: src/components/common/Button.jsx
================
import React from 'react';
import './Button.css';

export default function Button({ 
  children, 
  className = '', 
  variant = 'primary',
  size = 'medium',
  ...props 
}) {
  const buttonClass = `button ${variant}-button ${size}-button ${className}`;
  
  return (
    <button 
      className={buttonClass}
      {...props}
    >
      {children}
    </button>
  );
}

================
File: src/components/common/Footer.css
================
.footer {
  background-color: #0d0d0d;
  color: #fff;
  padding: 2rem 0;
  margin-top: 3rem;
}

.footer-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.footer-logo {
  margin-bottom: 1rem;
}

.footer-logo-text {
  font-family: 'Futura', 'Trebuchet MS', sans-serif;
  font-style: italic;
  font-weight: bold;
  font-size: 1.5rem;
  letter-spacing: 1px;
}

.footer-info p {
  margin: 0.5rem 0;
  color: #aaa;
}

.footer-small {
  font-size: 0.8rem;
  opacity: 0.8;
}

@media (max-width: 768px) {
  .footer {
    padding: 1.5rem 0;
  }
  
  .footer-logo-text {
    font-size: 1.2rem;
  }
}

================
File: src/components/common/Footer.jsx
================
import React from 'react';
import './Footer.css';

export default function Footer() {
  return (
    <footer className="footer">
      <div className="container">
        <div className="footer-content">
          <div className="footer-logo">
            <span className="footer-logo-text">trap.</span>
          </div>
          <div className="footer-info">
            <p>&copy; {new Date().getFullYear()} trap. All rights reserved.</p>
            <p className="footer-small">
              Please drink responsibly. Must be 18+ to consume alcohol in Australia.
            </p>
          </div>
        </div>
      </div>
    </footer>
  );
}

================
File: src/components/common/Header.css
================
.header {
  background-color: #0d0d0d;
  padding: 1rem 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
  position: sticky;
  top: 0;
  z-index: 100;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.logo-link {
  text-decoration: none;
}

.logo {
  display: flex;
  align-items: center;
}

.logo-text {
  font-family: 'Futura', 'Trebuchet MS', sans-serif;
  font-style: italic;
  font-weight: bold;
  font-size: 1.8rem;
  color: #fff;
  letter-spacing: 1px;
}

@media (max-width: 768px) {
  .logo-text {
    font-size: 1.5rem;
  }
}

================
File: src/components/common/Header.jsx
================
import React from 'react';
import { Link } from 'react-router-dom';
import './Header.css';

export default function Header() {
  return (
    <header className="header">
      <div className="container">
        <div className="header-content">
          <Link to="/" className="logo-link">
            <div className="logo">
              <span className="logo-text">trap.</span>
            </div>
          </Link>
        </div>
      </div>
    </header>
  );
}

================
File: src/components/common/Input.css
================
.input-wrapper {
  margin-bottom: 0.5rem;
  width: 100%;
}

.input {
  display: block;
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  line-height: 1.5;
  color: #ffffff;
  background-color: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.input:focus {
  border-color: #ff007f;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(255, 0, 127, 0.25);
}

.input-error {
  border-color: #ff3333;
}

.input-error:focus {
  border-color: #ff3333;
  box-shadow: 0 0 0 0.2rem rgba(255, 51, 51, 0.25);
}

.input-error-message {
  font-size: 0.8rem;
  color: #ff3333;
  margin-top: 0.25rem;
}

/* Specific input types */
.input[type="date"] {
  padding: 10px 12px;
  color-scheme: dark;
}

.otp-input {
  width: 3rem !important;
  height: 3rem;
  font-size: 1.5rem;
  padding: 0.5rem;
  text-align: center;
  margin: 0 0.25rem;
}

================
File: src/components/common/Input.jsx
================
import React, { forwardRef } from 'react';
import './Input.css';

const Input = forwardRef(({ 
  className = '', 
  type = 'text',
  error,
  ...props 
}, ref) => {
  const inputClass = `input ${error ? 'input-error' : ''} ${className}`;
  
  return (
    <div className="input-wrapper">
      <input 
        className={inputClass}
        type={type}
        ref={ref}
        {...props}
      />
      {error && <div className="input-error-message">{error}</div>}
    </div>
  );
});

export default Input;

================
File: src/components/common/Layout.css
================
.layout {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background-color: #0d0d0d;
}

.main-content {
  flex: 1;
  padding: 2rem 0;
}

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

@media (max-width: 768px) {
  .main-content {
    padding: 1.5rem 0;
  }
}

================
File: src/components/common/Layout.jsx
================
import React from 'react';
import Header from './Header';
import Footer from './Footer';
import './Layout.css';

export default function Layout({ children }) {
  return (
    <div className="layout">
      <Header />
      <main className="main-content">
        <div className="container">
          {children}
        </div>
      </main>
      <Footer />
    </div>
  );
}

================
File: src/components/confirm/VisitConfirm.jsx
================
// src/components/confirm/VisitConfirm.jsx
import React, { useState, useEffect } from 'react';
import { useParams, useSearchParams, useNavigate } from 'react-router-dom';
import { confirmVisit, supabase } from '../../api/supabase';
import { updateContactStage, completeFunnel, sendFinalThanksEmail } from '../../api/brevo'; // Added sendFinalThanksEmail
import Button from '../common/Button';
import Input from '../common/Input';

export default function VisitConfirm() {
  const { token } = useParams();
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const visitType = searchParams.get('type') || 'spicy-margarita';

  const [isConfirming, setIsConfirming] = useState(false);
  const [confirmed, setConfirmed] = useState(false);
  const [error, setError] = useState('');
  const [guestInfo, setGuestInfo] = useState(null);
  const [showPasswordPrompt, setShowPasswordPrompt] = useState(false);
  const [bartenderPassword, setBartenderPassword] = useState('');
  const [passwordError, setPasswordError] = useState('');
  const [isLoading, setIsLoading] = useState(true);
  const [alreadyRedeemed, setAlreadyRedeemed] = useState(false);

  const BARTENDER_ACCESS_CODE = 'drank';

  useEffect(() => {
    console.log('[VisitConfirm] useEffect triggered. Token:', token, 'VisitType:', visitType);
    setIsLoading(true);
    setAlreadyRedeemed(false);
    setError('');
    setGuestInfo(null); 

    let localDecodedGuestId = '';
    let localDecodedFullName = 'Guest'; 

    if (!token) {
      setError('Missing confirmation token.');
      setIsLoading(false);
      setAlreadyRedeemed(true);
      console.error('[VisitConfirm] useEffect: No token found.');
      return;
    }

    try {
      const decoded = atob(token);
      const [id, name] = decoded.split('|');
      console.log('[VisitConfirm] useEffect: Decoded token parts - id:', id, 'name:', name);

      if (id && id.trim() !== '') {
        localDecodedGuestId = id.trim();
        if (name && name.trim() !== '') localDecodedFullName = name.trim();
        setGuestInfo({ guestId: localDecodedGuestId, fullName: localDecodedFullName });
      } else {
        setError('Invalid confirmation link: Guest ID missing or empty in token.');
        setIsLoading(false);
        setAlreadyRedeemed(true);
        console.error('[VisitConfirm] useEffect: Invalid ID in token.');
        return;
      }
    } catch (err) {
      setError('Invalid confirmation link format (decoding error).');
      setIsLoading(false);
      setAlreadyRedeemed(true);
      console.error('[VisitConfirm] useEffect: Token decoding error:', err);
      return;
    }

    const checkVisitStatus = async (guestIdFromToken, currentVisitType) => {
      console.log('[VisitConfirm] checkVisitStatus called for guestId:', guestIdFromToken, 'visitType:', currentVisitType);
      if (!guestIdFromToken) {
        setError("Guest ID could not be determined.");
        setAlreadyRedeemed(true);
        setIsLoading(false);
        return;
      }

      let expectedVisitNumberForOffer;
      let stageRequiredToAccessThisOffer;

      switch (currentVisitType) {
        case 'spicy-margarita': 
          expectedVisitNumberForOffer = 1; stageRequiredToAccessThisOffer = 1; break;
        case 'icey-margarita': 
          expectedVisitNumberForOffer = 2; stageRequiredToAccessThisOffer = 2; break;
        case 'free-cocktail': 
          expectedVisitNumberForOffer = 3; stageRequiredToAccessThisOffer = 3; break;
        default:
          setError(`Unknown offer type: ${currentVisitType}.`);
          setAlreadyRedeemed(true);
          setIsLoading(false);
          console.error('[VisitConfirm] checkVisitStatus: Unknown visit type.');
          return;
      }

      try {
        const { data: guest, error: guestError } = await supabase
          .from('guests')
          .select('stage, full_name')
          .eq('id', guestIdFromToken)
          .single();

        if (guestError || !guest) {
          setError('Could not retrieve guest information to check eligibility.');
          setAlreadyRedeemed(true);
          console.error('[VisitConfirm] checkVisitStatus: Error fetching guest or guest not found:', guestError);
        } else {
          setGuestInfo(prev => ({ 
            ...(prev || {}), 
            guestId: guestIdFromToken, 
            fullName: guest.full_name || (prev ? prev.fullName : 'Guest') 
          }));
          console.log('[VisitConfirm] checkVisitStatus: Guest data fetched. Stage:', guest.stage, 'DB FullName:', guest.full_name);

          // Check if funnel already completed (guest.stage is 4 or higher)
          if (guest.stage >= 4) {
            setError(`This funnel has already been completed for ${guest.full_name || 'this guest'}.`);
            setAlreadyRedeemed(true); // Treat as redeemed/completed
          } else if (guest.stage < stageRequiredToAccessThisOffer) {
             setError(`This offer (${currentVisitType.replace(/-/g, ' ')}) is not yet available. Please complete the previous step(s). Current stage: ${guest.stage}.`);
             setAlreadyRedeemed(true); 
          } else if (guest.stage > stageRequiredToAccessThisOffer) {
              if (!(currentVisitType === 'free-cocktail' && guest.stage === 3)) { 
                   setError(`This offer (${currentVisitType.replace(/-/g, ' ')}) appears to have already been passed in the funnel. Current stage: ${guest.stage}.`);
                   setAlreadyRedeemed(true);
              }
          }
          
          if (!alreadyRedeemed) { 
              const { data: existingVisit, error: visitCheckError } = await supabase
                .from('visits')
                .select('id')
                .eq('guest_id', guestIdFromToken)
                .eq('visit_number', expectedVisitNumberForOffer)
                .maybeSingle(); 

              if (visitCheckError) {
                setError('Could not check specific visit redemption status.');
                setAlreadyRedeemed(true); 
                console.error('[VisitConfirm] checkVisitStatus: Error checking visits table:', visitCheckError);
              } else if (existingVisit) {
                setError(`This ${currentVisitType.replace(/-/g, ' ')} offer has already been redeemed (Visit ${expectedVisitNumberForOffer} recorded).`);
                setAlreadyRedeemed(true);
              }
          }
        }
      } catch(e) {
          setError("An unexpected error occurred while checking visit status.");
          setAlreadyRedeemed(true);
          console.error('[VisitConfirm] checkVisitStatus: Unexpected error:', e);
      } finally {
          setIsLoading(false);
      }
    };

    if (localDecodedGuestId) {
      checkVisitStatus(localDecodedGuestId, visitType);
    } else {
        setIsLoading(false);
    }

  }, [token, visitType, navigate]); 

  const getVisitInfoText = () => {
    switch (visitType) {
      case 'icey-margarita': return { title: 'weve invented something new. an icey margarita!', description: 'you have heard of a spicy one. this is an icey one.' };
      case 'free-cocktail': return { title: 'boom. free cocktail.', description: 'have a house cocktail on us!' };
      case 'spicy-margarita': return { title: 'spicy. spicy. marg', description: 'well arent you special.' };
      default: return { title: 'Special Offer', description: 'Please show this to your bartender.' };
    }
  };

  const { title, description } = getVisitInfoText();

  const processVisitConfirmation = async () => {
    console.log('[VisitConfirm] processVisitConfirmation called. Current guestInfo:', JSON.stringify(guestInfo), 'alreadyRedeemed:', alreadyRedeemed);
    
    if (!guestInfo || !guestInfo.guestId || typeof guestInfo.guestId !== 'string' || guestInfo.guestId.trim() === '' || alreadyRedeemed) {
      console.error('processVisitConfirmation ABORTED: guestInfo, guestInfo.guestId is invalid, or alreadyRedeemed.');
      setError('Cannot confirm visit: Essential guest information is missing or the offer is invalid/already used.');
      setIsConfirming(false);
      return;
    }

    setError(''); 
    setPasswordError(''); 
    setIsConfirming(true);

    let expectedVisitNumber;
    switch (visitType) {
        case 'spicy-margarita': expectedVisitNumber = 1; break;
        case 'icey-margarita': expectedVisitNumber = 2; break;
        case 'free-cocktail': expectedVisitNumber = 3; break;
        default:
            setError("Cannot determine expected visit number for confirmation due to unknown visit type.");
            setIsConfirming(false);
            console.error('[VisitConfirm] processVisitConfirmation: Unknown visit type for expectedVisitNumber.');
            return;
    }
    console.log('[VisitConfirm] processVisitConfirmation: Attempting to confirm visit for guestId:', guestInfo.guestId, 'expectedVisitNumber:', expectedVisitNumber);

    try {
      const result = await confirmVisit(guestInfo.guestId, expectedVisitNumber);
      console.log('[VisitConfirm] processVisitConfirmation: RPC result:', result);
      
      if (result.success) {
        if (result.email && result.guest_id && result.full_name) {
            // After any successful visit confirmation:
            if (visitType === 'free-cocktail') { 
                // This was the 3rd (final) visit
                console.log('[VisitConfirm] Funnel complete! Calling completeFunnel for Brevo. DB stage should now be 4.');
                await completeFunnel(result.email, new Date()); // Updates Brevo: FUNNEL_COMPLETED=true, STAGE=4, clears coupon paths

                console.log('[VisitConfirm] Sending final thanks email.');
                await sendFinalThanksEmail(result.email, result.full_name); // Sends transactional final email
            } else {
                // This was visit 1 or 2. Update Brevo stage and set next coupon attributes.
                // result.stage from RPC will be 2 (after visit 1) or 3 (after visit 2).
                console.log(`[VisitConfirm] Visit ${result.visit_number} confirmed. Updating Brevo stage to ${result.stage} and setting next coupon attributes.`);
                await updateContactStage(result.email, result.stage, { 
                    guestId: result.guest_id, 
                    fullName: result.full_name 
                });
            }
        } else {
            console.warn("[VisitConfirm] Email, guest_id, or full_name not available from confirmVisit RPC. Brevo update might be incomplete. GuestID from state:", guestInfo.guestId);
        }
        setConfirmed(true);
      } else {
        setError(result.message || 'Failed to confirm visit. The offer might have already been redeemed or there was an issue.');
        if (result.message && (result.message.toLowerCase().includes("already redeemed") || result.message.toLowerCase().includes("already recorded"))) {
            setAlreadyRedeemed(true); 
        }
      }
    } catch (err) {
      console.error('[VisitConfirm] processVisitConfirmation: Error during API call or Brevo update:', err);
      setError('An unexpected error occurred. Please try again or contact support.');
    } finally {
      setIsConfirming(false);
    }
  };

  const handleInitialConfirmClick = () => {
    console.log('[VisitConfirm] handleInitialConfirmClick. Current guestInfo:', JSON.stringify(guestInfo));
    if (alreadyRedeemed) {
        setError("This offer has already been processed and cannot be confirmed again.");
        return;
    }
    if (!guestInfo || !guestInfo.guestId || guestInfo.guestId.trim() === '') {
        setError("Cannot proceed: Guest details are not fully loaded or are invalid. Please refresh or check the link.");
        return;
    }
    setShowPasswordPrompt(true);
    setError(''); 
    setPasswordError(''); 
  };

  const handlePasswordSubmit = () => {
    if (bartenderPassword === BARTENDER_ACCESS_CODE) {
      setShowPasswordPrompt(false); 
      setBartenderPassword(''); 
      processVisitConfirmation(); 
    } else {
      setPasswordError('Incorrect access code. Please try again.');
    }
  };
  
  console.log('[VisitConfirm] Rendering. isLoading:', isLoading, 'alreadyRedeemed:', alreadyRedeemed, 'confirmed:', confirmed, 'error:', error, 'guestInfo:', JSON.stringify(guestInfo));

  if (isLoading) {
    return (
      <div className="visit-confirmation-container" style={{ textAlign: 'center', padding: '2rem' }}>
        <p>Loading offer details, please wait...</p>
      </div>
    );
  }
  
  if (alreadyRedeemed && !confirmed) { 
    return (
      <div className="visit-confirmation-container confirmation-card" style={{ textAlign: 'center', padding: '2rem' }}>
        <h2>nice try bozo.</h2>
        <p className="error-message" style={{backgroundColor: 'transparent', border: 'none', color: '#ff6b6b', fontSize: '1.1rem', marginBottom: '1rem'}}>{error || 'This offer has already been used or is not currently available.'}</p>
        <Button onClick={() => window.close()} variant="secondary" style={{marginTop: '1rem'}}>close.</Button>
      </div>
    );
  }

  if (confirmed) {
    return (
      <div className="voucher-display-container"> {/* Re-using main container for consistent styling */}
        <div className="voucher-confirmation-container"> {/* Specific styling for success message */}
            <div className="success-icon">✓</div>
            <h2>hey you! get back to work!</h2>
            <p>haven't we gone through this before?</p>
                    {visitType !== 'free-cocktail' && <p>as always, we hope you enjoy your drink! - keep an eye on your email in the coming days for another something special from us.</p>}
        {visitType === 'free-cocktail' && <p>thats all from us for now! enjoy your free house cocktail and thanks for being awesome.</p>}

        </div>
         <Button onClick={() => window.close()} variant="secondary" style={{marginTop: '2rem'}}>close.</Button>
      </div>
    );
  }

  if (error && !showPasswordPrompt && !isLoading && !alreadyRedeemed && !confirmed) {
     return (
      <div className="visit-confirmation-container confirmation-card" style={{ textAlign: 'center', padding: '2rem' }}>
        <h2>Error Loading Offer</h2>
        <p className="error-message" style={{backgroundColor: 'transparent', border: 'none', color: '#ff6b6b', fontSize: '1.1rem', marginBottom: '1rem'}}>{error}</p>
        <p>Please ask the customer to show their voucher again or check the link.</p>
        <Button onClick={() => window.location.reload()} variant="primary" style={{marginTop: '1rem'}}>Retry</Button>
      </div>
    );
  }

  if (!guestInfo && !isLoading) {
    return (
      <div className="visit-confirmation-container" style={{ textAlign: 'center', padding: '2rem' }}>
        <p>Could not load guest details from the link. Please ensure the link is correct.</p>
        <Button onClick={() => window.location.reload()} variant="primary" style={{marginTop: '1rem'}}>Retry</Button>
      </div>
    );
  }

  return (
    <div className="visit-confirmation-container">
      <div className="confirmation-card">
        <div className="confirmation-header">
          <h2>{title}</h2>
          <p className="confirmation-type">{description}</p>
        </div>

        {guestInfo && guestInfo.fullName && (
          <div className="guest-details">
            <p className="guest-name">
              <strong>full name:</strong> {guestInfo.fullName}
            </p>
          </div>
        )}

        <div className="bartender-section">
          
          {passwordError && <div className="error-message" style={{ marginBottom: '1rem' }}>{passwordError}</div>}
          {error && !passwordError && <div className="error-message" style={{ marginBottom: '1rem' }}>{error}</div>}

          {!showPasswordPrompt ? (
            <>
              
              <Button
                onClick={handleInitialConfirmClick}
                className="confirm-btn"
                disabled={isConfirming || isLoading || !guestInfo || !guestInfo.guestId}
                variant="primary"
              >
                {isConfirming ? 'processing...' : `show this to your bartender.`}
              </Button>
            </>
          ) : (
            <div className="password-prompt-section" style={{ marginTop: '1rem' }}>
              <label htmlFor="bartenderPasswordConfirm" style={{ display: 'block', marginBottom: '0.5rem' }}>enter access code:</label>
              <Input
                type="password"
                id="bartenderPasswordConfirm"
                value={bartenderPassword}
                onChange={(e) => setBartenderPassword(e.target.value)}
                placeholder="bartender access code"
                style={{ marginBottom: '0.5rem' }}
                autoFocus
              />
              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.5rem', justifyContent: 'flex-end' }}>
                <Button
                  onClick={() => {
                    setShowPasswordPrompt(false);
                    setBartenderPassword('');
                    setPasswordError('');
                  }}
                  variant="secondary"
                  disabled={isConfirming}
                >
                  cancel
                </Button>
                <Button onClick={handlePasswordSubmit} variant="primary" disabled={isConfirming}>
                                  {isConfirming ? 'confirming...' : 'serve.'}
                                </Button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

================
File: src/components/landing/LandingForm.jsx
================
// src/components/landing/LandingForm.jsx
import React, { useState } from 'react';
import { signupLead } from '../../api/supabase';
import { updateContact, EmailTemplates, sendTransactionalEmail } from '../../api/brevo';
import Button from '../common/Button';
import Input from '../common/Input';

// Regular expression for email validation
const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

export default function LandingForm() {
  const [email, setEmail] = useState('');
  const [dob, setDob] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState(false);

  // Validate form fields
  const validateForm = () => {
    if (!email || !EMAIL_REGEX.test(email)) {
      setError('Please enter a valid email address');
      return false;
    }
    
    if (!dob) {
      setError('Please enter your date of birth');
      return false;
    }
    
    // Age validation
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    if (age < 18) {
      setError('You must be 18 or older to sign up');
      return false;
    }
    
    return true;
  };

  // Handle form submission
  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    
    if (!validateForm()) return;
    
    setIsSubmitting(true);
    
    try {
      // Register lead in Supabase
      const result = await signupLead(email, dob);
      console.log('[LandingForm] Supabase signupLead result:', result);
      
      if (!result.success || !result.guest_id) { // Ensure guest_id is present
        setError(result.message || 'Failed to sign up. Please try again.');
        setIsSubmitting(false);
        return;
      }
      const { guest_id: newGuestId } = result; 
      
      const brevoListIdForNewSignups = 7; 

      // Prepare attributes for Brevo contact update
      const attributesForBrevo = {
        STAGE: 0,
        LAST_STAGE_UPDATE: new Date().toISOString(), // Use consistent attribute name
        DOB: dob,
        GUEST_ID: newGuestId, // <<<<<<< CRITICAL FIX: Add GUEST_ID attribute
        // Optional: Set placeholder names if your Brevo templates might use them early
        // FULL_NAME: "New Lead", 
        // FIRST_NAME: "New",
      };
      console.log('[LandingForm] Attributes for initial Brevo contact update:', JSON.stringify(attributesForBrevo));
      await updateContact(email, attributesForBrevo, [brevoListIdForNewSignups]);
      
      // Prepare for voucher email
      const voucherToken = btoa(`${newGuestId}|${email}`); // Token for /voucher page
      const voucherLink = `${window.location.origin}/voucher?token=${voucherToken}`;
      console.log('[LandingForm] Sending signup voucher email (Template ID 1) with VOUCHER_LINK:', voucherLink);

      
      await sendTransactionalEmail(
       49, 
       { email }, 
        {
          VOUCHER_LINK: voucherLink, 
          EMAIL: email 
        }
      );
      
      
      console.log('[LandingForm] Signup process successful.');
      setSuccess(true);
    } catch (err) {
      console.error('[LandingForm] Error during signup process:', err);
      setError('An unexpected error occurred. Please try again later.');
    } finally {
      setIsSubmitting(false);
    }
  };

  // If signup was successful
  if (success) {
    return (
      <div className="success-container bg-dark rounded-lg shadow p-6 text-center">
        <div className="text-pink success-icon">✓</div>
        <h2 className="text-2xl font-bold mb-4">check your email! 📧</h2>
        <p className="mb-4">
          we've sent you a link with your free spicy margarita voucher.
          come to the bar, open the email and click the link to claim it!
        </p>
        <p className="text-sm text-gray-400">
          <i>don't see it? check your spam fam.</i>
        </p>
        <Button 
          className="w-full py-3 mt-4" // Added mt-4 for spacing
          variant="primary"
          onClick={() => window.open('https://www.trapadl.com/', '_blank')}
        >
          find out more about trap.
        </Button><br /><br />
        <Button 
          className="w-full py-3"
          variant="primary"
          onClick={() => window.open('https://www.instagram.com/trap.adl', '_blank')}
        >
          our instagram.
        </Button><br /><br />
        <Button 
          className="w-full py-3"
          variant="primary"
          onClick={() => window.open('https://docs.google.com/forms/d/e/1FAIpQLSe57gW9pysQn_LBf5PKRmur-yoccAw3rXOiFYUdNK2N3EszSQ/viewform', '_blank')}
        >
          make a booking.
        </Button>
      </div>
    );
  }

  // Main form
  return (
    <div className="landing-form-container">
      <h2>here's a free spicy margarita from the team at trap.</h2>
      <p className="tagline">
        our margs are the best you'll ever have. We make our own house-fermented 
        chili special, and we're so confident you'll love them - here's a free one!
      </p>
      
      <form onSubmit={handleSubmit}>
        {error && (
          <div className="error-message">
            {error}
          </div>
        )}
        
        <div className="form-group mb-4">
          <label htmlFor="email" className="block font-medium mb-1">Email Address</label>
          <Input
            id="email"
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="your@email.com"
            required
          />
        </div>
        
        <div className="form-group mb-6">
          <label htmlFor="dob" className="block font-medium mb-1">Date of Birth</label>
          <Input
            id="dob"
            type="date"
            value={dob}
            onChange={(e) => setDob(e.target.value)}
            max={new Date(Date.now() - 18 * 365.25 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]} // Max date is 18 years ago
            required
          />
          <p className="dob-note text-sm text-gray-400 mt-1">You must be 18+ to redeem this offer</p>
        </div>
        
        <Button 
          type="submit" 
          className="w-full py-3"
          variant="primary"
          disabled={isSubmitting}
        >
          {isSubmitting ? 'Sending...' : 'get my free margarita'}
        </Button>
        
        <p className="terms-text text-sm text-gray-400 text-center mt-4">
          By submitting, you agree to receive marketing emails from trap. 
          You can unsubscribe at any time.
        </p>
      </form>
    </div>
  );
}

================
File: src/components/voucher/OtpVerify.jsx
================
import React, { useState, useEffect, useRef } from 'react';
import { verifyOtp, sendOtp } from '../../api/supabase';
import { sendOtpSms, updateContactStage } from '../../api/brevo';
import Button from '../common/Button';
import Input from '../common/Input';
import VoucherDisplay from './VoucherDisplay';

export default function OtpVerify({ guestId, phone, fullName, onBackToForm }) {
  const [otp, setOtp] = useState(['', '', '', '', '', '']);
  const [error, setError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [countdown, setCountdown] = useState(60);
  const [canResend, setCanResend] = useState(false);
  const [verified, setVerified] = useState(false);
  const inputRefs = useRef([]);
  
  // Set up countdown timer for OTP resend
  useEffect(() => {
    if (countdown > 0 && !canResend) {
      const timer = setTimeout(() => setCountdown(countdown - 1), 1000);
      return () => clearTimeout(timer);
    } else if (countdown === 0 && !canResend) {
      setCanResend(true);
    }
  }, [countdown, canResend]);
  
  // Handle input of each OTP digit
  const handleOtpChange = (index, value) => {
    // Only allow numbers
    if (value && !/^\d+$/.test(value)) return;
    
    // Update OTP array
    const newOtp = [...otp];
    newOtp[index] = value;
    setOtp(newOtp);
    
    // Auto-focus next input
    if (value && index < 5) {
      inputRefs.current[index + 1].focus();
    }
  };
  
  // Handle key press for backspace
  const handleKeyDown = (index, e) => {
    // Move to previous input on backspace if current is empty
    if (e.key === 'Backspace' && !otp[index] && index > 0) {
      inputRefs.current[index - 1].focus();
    }
  };
  
  // Handle form submission
  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    
    const otpString = otp.join('');
    if (otpString.length !== 6) {
      setError('Please enter the complete 6-digit code');
      return;
    }
    
    setIsSubmitting(true);
    
    try {
      // Verify OTP via Supabase
      const result = await verifyOtp(guestId, otpString, fullName);
      
      if (!result.success) {
        setError(result.message || 'Invalid verification code. Please try again.');
        setIsSubmitting(false);
        return;
      }
      
      // Update contact stage in Brevo
      await updateContactStage(result.email, 1);
      
      // Show voucher display
      setVerified(true);
    } catch (err) {
      console.error('Error verifying OTP:', err);
      setError('An unexpected error occurred. Please try again later.');
    } finally {
      setIsSubmitting(false);
    }
  };
  
  // Handle OTP resend
  const handleResend = async () => {
    setError('');
    setCanResend(false);
    setCountdown(60);
    
    try {
      // Resend OTP via Supabase
      const result = await sendOtp(guestId, phone);
      
      if (!result.success) {
        setError(result.message || 'Failed to resend code. Please try again.');
        setCanResend(true);
        return;
      }
      
      // Send OTP SMS via Brevo
      await sendOtpSms(phone, result.otp);
    } catch (err) {
      console.error('Error resending OTP:', err);
      setError('An unexpected error occurred. Please try again later.');
      setCanResend(true);
    }
  };
  
  // If verified, show voucher display
  if (verified) {
    return <VoucherDisplay guestId={guestId} fullName={fullName} />;
  }
  
  // OTP verification form
  return (
    <div className="otp-verification-container">
      <h2>get verified.</h2>
      <p className="tagline">
        we've sent a 6-digit code to {phone}. enter it below to become verified.
      </p>
      
      {error && <div className="error-message">{error}</div>}
      
      <form onSubmit={handleSubmit}>
        <div className="otp-inputs">
          {otp.map((digit, index) => (
            <Input
              key={index}
              type="text"
              maxLength={1}
              value={digit}
              onChange={(e) => handleOtpChange(index, e.target.value)}
              onKeyDown={(e) => handleKeyDown(index, e)}
              ref={(el) => (inputRefs.current[index] = el)}
              className="otp-input"
              autoFocus={index === 0}
            />
          ))}
        </div>
        
        <div className="otp-actions">
          <Button 
            type="submit" 
            className="primary-btn"
            disabled={isSubmitting || otp.join('').length !== 6}
          >
            {isSubmitting ? 'Verifying...' : 'Verify Code'}
          </Button>
          
          <div className="resend-section">
            {canResend ? (
              <button 
                type="button"
                className="text-btn"
                onClick={handleResend}
              >
                resend code.
              </button>
            ) : (
              <p className="countdown-text">
                resend code in {countdown} seconds.
              </p>
            )}
          </div>
        </div>
        
        <button 
          type="button"
          className="text-btn back-btn"
          onClick={onBackToForm}
        >
          &larr; go back.
        </button>
      </form>
    </div>
  );
}

================
File: src/components/voucher/VoucherDisplay.jsx
================
import React, { useState } from 'react';
import { confirmVisit } from '../../api/supabase'; // Assuming confirmVisit is correctly in api/supabase
import { updateContactStage } from '../../api/brevo'; // Assuming this is correctly in api/brevo
import Button from '../common/Button';
import Input from '../common/Input';

export default function VoucherDisplay({ guestId, fullName }) {
  const [isConfirming, setIsConfirming] = useState(false);
  const [confirmed, setConfirmed] = useState(false); // True if this specific redemption attempt was successful
  const [error, setError] = useState('');
  const [showPasswordPrompt, setShowPasswordPrompt] = useState(false);
  const [bartenderPassword, setBartenderPassword] = useState('');
  const [passwordError, setPasswordError] = useState('');
  // No alreadyRedeemed state here, as VoucherForm should prevent reaching this if already fully redeemed.
  // This component's purpose is to attempt the *first* visit confirmation.

  const voucherCode = `SPICY-${Math.random().toString(36).substring(2, 7).toUpperCase()}`;
  const BARTENDER_ACCESS_CODE = 'drank';
  
  const processVisitConfirmation = async () => {
    setError('');
    setPasswordError('');
    setIsConfirming(true);
    
    try {
      // Attempt to confirm the FIRST visit (expectedVisitNumber = 1)
      const result = await confirmVisit(guestId, 1); 
      
      if (result.success) {
        if(result.email) { // Check if email is available from RPC
            await updateContactStage(result.email, result.stage, { // result.stage should be 2
                guestId: result.guest_id,
                fullName: result.full_name
            });
        } else {
            console.warn("Email not available from confirmVisit RPC, Brevo update for stage 2 skipped. GuestID:", guestId);
        }
        setConfirmed(true); // Mark this redemption attempt as successful
        setTimeout(() => { 
            // Try to close the window; may not work depending on how it was opened
            // window.close(); 
            // Alternatively, navigate or show a persistent success message
        }, 10000);
      } else {
        // Handle errors from confirmVisit, including "already recorded"
        setError(result.message || 'Failed to confirm visit. Please try again.');
        // If it's already recorded, the bartender can't re-confirm here.
        // The VoucherForm should have ideally caught this if stage >= 2.
      }
    } catch (err) {
      console.error('Error confirming visit:', err);
      setError('An unexpected error occurred. Please try again.');
    } finally {
      setIsConfirming(false);
    }
  };
  
  const handleInitialConfirmClick = () => {
    setShowPasswordPrompt(true);
    setError(''); 
    setPasswordError(''); 
  };

  const handlePasswordSubmit = () => {
    if (bartenderPassword === BARTENDER_ACCESS_CODE) {
      setShowPasswordPrompt(false); 
      setBartenderPassword(''); 
      processVisitConfirmation(); 
    } else {
      setPasswordError('Incorrect password. Please try again.');
    }
  };

  if (confirmed) {
    return (
      <div className="voucher-display-container"> {/* Re-using main container for consistent styling */}
        <div className="voucher-confirmation-container"> {/* Specific styling for success message */}
            <div className="success-icon">✓</div>
            <h2>hey you! get back to work!</h2>
            <p>our valued guest, {fullName || 'Guest'}, is waiting for their spicy marg.</p>
            <p>we hope you enjoy it - keep an eye on your email in the coming days for another something special from us.</p>
        </div>
      </div>
    );
  }
  
  return (
    <div className="voucher-display-container">
      <div className="voucher-card">
        <div className="voucher-header">
          <h2>good for one spicy marg.</h2>
        </div>
        
        <div className="voucher-details">
          <p className="voucher-name">
            <strong>name:</strong> {fullName || "Guest (Name not provided)"}
          </p>
         
        </div>
        
        <div className="bartender-section">
          
          {/* Display error from confirmVisit if it occurs (e.g. already recorded) */}
          {error && <div className="error-message">{error}</div>} 
          {passwordError && <div className="error-message" style={{ marginBottom: '1rem' }}>{passwordError}</div>}

          {!showPasswordPrompt ? (
            <>
              
              <Button
                onClick={handleInitialConfirmClick}
                className="confirm-btn"
                variant="primary"
                disabled={isConfirming} // Disable if already confirmed this session or during API call
              >
                {isConfirming ? 'processing...' : 'show this screen to your bartender.'}
              </Button>
            </>
          ) : (
            <div className="password-prompt-section" style={{ marginTop: '1rem' }}>
              <label htmlFor="bartenderPassword" style={{display: 'block', marginBottom: '0.5rem'}}>enter access code:</label>
              <Input
                type="password"
                id="bartenderPassword"
                value={bartenderPassword}
                onChange={(e) => setBartenderPassword(e.target.value)}
                placeholder="bartender access code"
                style={{marginBottom: '0.5rem'}}
              />
              <div style={{ display: 'flex', gap: '0.5rem', marginTop: '0.5rem' }}>
                <Button onClick={() => { setShowPasswordPrompt(false); setBartenderPassword(''); setPasswordError(''); }} variant="secondary" disabled={isConfirming}>
                  cancel
                </Button>
                <Button onClick={handlePasswordSubmit} variant="primary" disabled={isConfirming}>
                  {isConfirming ? 'confirming...' : 'serve.'}
                </Button>
              </div>
            </div>
          )}
        </div>
      </div>

    </div>
  );
}

================
File: src/components/voucher/VoucherForm.jsx
================
import React, { useState, useEffect } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { sendOtp, supabase, getGuestStatusById } from '../../api/supabase'; // Add getGuestStatusById
import { sendOtpSms } from '../../api/brevo';
import Button from '../common/Button';
import Input from '../common/Input';
import OtpVerify from './OtpVerify';
import VoucherDisplay from './VoucherDisplay';

const PHONE_REGEX = /^\+?[0-9]{10,15}$/;

export default function VoucherForm() {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const token = searchParams.get('token');

  const [fullName, setFullName] = useState('');
  const [phone, setPhone] = useState('');
  const [email, setEmail] = useState('');
  const [guestId, setGuestId] = useState('');
  const [error, setError] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showOtpForm, setShowOtpForm] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [alreadyClaimedDetails, setAlreadyClaimedDetails] = useState(null); // Stores guest object if processed
  const [flowMessage, setFlowMessage] = useState('');

  useEffect(() => {
    setIsLoading(true);
    setError('');
    setFlowMessage('');
    setAlreadyClaimedDetails(null);
    setGuestId(''); // Reset derived states
    setEmail('');   // Reset derived states

    let localParsedGuestId = '';
    let localParsedEmail = '';

    if (token) {
      try {
        const decodedString = atob(token);
        const parts = decodedString.split('|');
        if (parts.length === 2 && parts[0] && parts[1]) {
          localParsedGuestId = decodeURIComponent(parts[0]);
          localParsedEmail = decodeURIComponent(parts[1]);
        } else {
          setError('Invalid voucher link (token content error).');
          setIsLoading(false);
          return;
        }
      } catch (err) {
        setError('Invalid voucher link (decoding error).');
        setIsLoading(false);
        return;
      }
    } else {
      setError('Missing voucher token.');
      setIsLoading(false);
      return;
    }

    setGuestId(localParsedGuestId); // Set state based on current token
    setEmail(localParsedEmail);   // Set state based on current token

    const checkGuestStatus = async (guestIdFromToken) => { // Removed emailFromToken as it's not needed if querying by ID
  if (!guestIdFromToken) {
    setError('Voucher link is missing essential guest information.');
    setIsLoading(false);
    return;
  }

  try {
    // const { data: guest, error: guestError } = await supabase // OLD DIRECT QUERY
    //   .from('guests')
    //   .select('id, full_name, phone, stage, email')
    //   .eq('id', guestIdFromToken)
    //   .single();
    
    const result = await getGuestStatusById(guestIdFromToken); // NEW RPC CALL

    if (!result.success || !result.guest) {
      // setError(result.message || 'Could not retrieve your details. Please try the link again or sign up.');
      // If guest not found by ID from token, it's an invalid link for this stage.
      setError('This voucher link is not associated with a valid signup. Please sign up first.');
    } else {
      const guest = result.guest;
      // Sync email state if guest object has it (it should from the RPC)
      if (guest.email) { // localParsedEmail is from token, guest.email from DB via RPC
         if (localParsedEmail && guest.email !== localParsedEmail) {
            console.warn("Email from DB differs from token, using DB email.", guest.email);
         }
         setEmail(guest.email);
      }


      if (guest.stage >= 2) {
        setFlowMessage("this one's been claimed. maybe you're thinking of a different voucher?");
        setAlreadyClaimedDetails(guest);
      } else if (guest.stage === 1) {
        setFlowMessage("phone verified, show this to your bartender.");
        setAlreadyClaimedDetails(guest);
      }
    }
  } catch (e) {
    setError("An error occurred while checking your voucher status.");
    console.error("Error in checkGuestStatus (VoucherForm):", e);
  } finally {
    setIsLoading(false);
  }
};

    if (localParsedGuestId) { // Only proceed if guestId was successfully parsed from token
        checkGuestStatus(localParsedGuestId);
    } else {
        // This case means localParsedGuestId wasn't set from token, error should have been set earlier.
        setIsLoading(false);
    }

  }, [token, navigate, supabase]);


  const handlePhoneChange = (e) => {
    let value = e.target.value;
    if (value.startsWith('0')) {
      value = '+61' + value.substring(1);
    }
    setPhone(value);
  };

  const validateForm = () => {
    if (!guestId) {
        setError('Guest information is missing (No Guest ID). Cannot send OTP.');
        return false;
    }
    if (!fullName || fullName.trim().length < 2) {
      setError('Please enter your full name');
      return false;
    }
    if (!phone || !PHONE_REGEX.test(phone)) {
      setError('Please enter a valid phone number (e.g., +61412345678 or 0412345678).');
      return false;
    }
    return true;
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    if (!validateForm()) return;
    setIsSubmitting(true);

    try {
      const formattedPhone = phone.startsWith('+') ? phone : `+61${phone.substring(phone.startsWith('0') ? 1 : 0)}`;
      const result = await sendOtp(guestId, formattedPhone); 

      if (!result.success) {
        setError(result.message || 'Failed to send verification code. Please try again.');
      } else {
        await sendOtpSms(formattedPhone, result.otp);
        setShowOtpForm(true);
      }
    } catch (err) {
      console.error('Error sending OTP:', err);
      setError('An unexpected error occurred. Please try again later.');
    } finally {
      setIsSubmitting(false);
    }
  };

  if (isLoading) {
    return ( <div className="voucher-form-container" style={{ textAlign: 'center' }}><p>Loading...</p></div> );
  }

  if (error) { 
    return ( 
      <div className="voucher-form-container" style={{ textAlign: 'center' }}>
        <div className="error-message" style={{marginBottom: '1rem'}}>{error}</div>
        <Button onClick={()=>navigate('/')} variant="primary">Go to Homepage</Button> 
      </div> 
    );
  }
  
  if (alreadyClaimedDetails) {
    if (alreadyClaimedDetails.stage >= 2) { 
      return (
          <div className="voucher-form-container confirmation-card" style={{ textAlign: 'center' }}>
            <h2>nice try 🤡</h2>
            <p style={{marginBottom: '1rem'}}>{flowMessage || "This offer has already been processed."}</p>
            <Button onClick={() => window.close()} variant="secondary" style={{marginTop: '1rem'}}>close</Button>
          </div>
      );
    }
    // Stage is 1: phone verified, margarita not yet redeemed. Show VoucherDisplay.
    return <VoucherDisplay guestId={alreadyClaimedDetails.guestId} fullName={alreadyClaimedDetails.fullName || "Valued Guest"} />;
  }

  if (showOtpForm) {
    return (
      <OtpVerify
        guestId={guestId} 
        phone={phone}
        fullName={fullName}
        onBackToForm={() => setShowOtpForm(false)}
      />
    );
  }

  return (
    <div className="voucher-form-container">
      <h2>get your free spicy marg.</h2>
      <p className="tagline">
        almost there! just verify your number so we know its you.
      </p>
      {/* Display error here if it occurred before form submission */}
      {error && !isSubmitting && <div className="error-message">{error}</div>}
      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label htmlFor="fullName"></label>
          <Input
            id="fullName"
            type="text"
            value={fullName}
            onChange={(e) => setFullName(e.target.value)}
            placeholder="full name"
            required
          />
        </div>
        <div className="form-group">
          <label htmlFor="phone"></label>
          <Input
            id="phone"
            type="tel"
            value={phone}
            onChange={handlePhoneChange}
            placeholder="phone number e.g. +61412345678 or 0412345678"
            required
          />
          <p className="small-text">get ready for a verification code</p>
        </div>
        <Button
          type="submit"
          variant="primary"
          disabled={isSubmitting || !guestId || isLoading} 
        >
          {isSubmitting ? 'sending code...' : 'send code.'}
        </Button>
        <p className="terms-text">
          By verifying, you agree to receive SMS notifications related to this offer.
          Standard message rates may apply. Reply STOP to opt out.
        </p>
      </form>
    </div>
  );
}

================
File: src/pages/AdminPage.css
================
/* Admin page styling */
.admin-container {
    background-color: #0d0d0d;
    min-height: 100vh;
    color: white;
  }
  
  .admin-header {
    background-color: #121212;
    padding: 20px;
    border-bottom: 1px solid #2a2a2a;
    margin-bottom: 30px;
  }
  
  .admin-title {
    color: white;
    font-size: 1.8rem;
    font-weight: 700;
    font-family: 'Playfair Display', serif;
    margin: 0;
    text-align: center;
  }
  
  .tab-navigation {
    display: flex;
    justify-content: center;
    margin: 20px 0 30px;
    flex-wrap: wrap;
    gap: 10px;
  }
  
  .tab-button {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }
  
  .tab-button.active {
    background-color: #ff007f;
    color: white;
  }
  
  .tab-button:not(.active) {
    background-color: #1a1a1a;
    color: #ccc;
  }
  
  .tab-button:not(.active):hover {
    background-color: #252525;
  }
  
  .logout-button {
    background-color: #333;
    color: white;
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.2s;
    margin-left: 15px;
  }
  
  .logout-button:hover {
    background-color: #444;
  }
  
  .admin-content {
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 20px;
  }
  
  .alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .alert-error {
    background-color: rgba(255, 77, 109, 0.2);
    border-left: 4px solid #ff4d6d;
    color: #ff6b81;
  }
  
  .alert-success {
    background-color: rgba(66, 245, 179, 0.2);
    border-left: 4px solid #42f5b3;
    color: #7df5c5;
  }
  
  .alert-dismiss {
    background: none;
    border: none;
    color: inherit;
    font-size: 0.9rem;
    cursor: pointer;
    text-decoration: underline;
  }
  
  /* Login form */
  .login-container {
    max-width: 400px;
    margin: 100px auto;
    background-color: #121212;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
  }
  
  .login-title {
    text-align: center;
    margin-bottom: 25px;
    color: white;
    font-size: 1.6rem;
    font-weight: 700;
    font-family: 'Playfair Display', serif;
  }
  
  .login-input {
    width: 100%;
    padding: 12px;
    margin-bottom: 20px;
    background-color: #1a1a1a;
    border: 1px solid #333;
    border-radius: 6px;
    color: white;
    font-size: 1rem;
  }
  
  .login-input:focus {
    border-color: #ff007f;
    outline: none;
    box-shadow: 0 0 0 2px rgba(255, 0, 127, 0.25);
  }
  
  .login-button {
    width: 100%;
    padding: 12px;
    background-color: #ff007f;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .login-button:hover {
    background-color: #e1006f;
  }
  
  .login-button:disabled {
    background-color: #962552;
    cursor: not-allowed;
  }
  
  /* Loading state */
  .loading-container {
    text-align: center;
    padding: 50px 0;
  }
  
  .loading-spinner {
    display: inline-block;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 0, 127, 0.3);
    border-radius: 50%;
    border-top-color: #ff007f;
    animation: spin 1s ease-in-out infinite;
    margin-bottom: 15px;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

================
File: src/pages/AdminPage.jsx
================
import React, { useState, useEffect } from 'react';
// Removed: import bcrypt from 'bcryptjs'; // No longer needed for client-side comparison
import Layout from '../components/common/Layout'; // Assuming Layout is not used here directly based on your styling
import { supabase, getFunnelStats, getMonthlyMetrics, updateMonthlyMetrics, deleteMonthlyMetrics } from '../api/supabase';
import FunnelStatsComponent from '../components/admin/FunnelStats'; // Renamed to avoid conflict
import MetricsTable from '../components/admin/MetricsTable';
import MetricsForm from '../components/admin/MetricsForm';
import MetricsDashboard from '../components/admin/MetricsDashboard';
import './AdminPage.css';

// REMOVED: const ADMIN_HASH = "$2a$10$WHhsESNuNV.P3CeVpibxgePItr4KnuCnQvuZVWqiz9DEh5svIv2sq";
// The actual hash is now an environment variable in the Supabase Edge Function

export default function AdminPage() {
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [isLoggingIn, setIsLoggingIn] = useState(false); // For login button state
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [successMessage, setSuccessMessage] = useState('');
  
  const [funnelStatsData, setFunnelStatsData] = useState([]); // Renamed state variable
  const [metrics, setMetrics] = useState([]);
  const [showMetricsForm, setShowMetricsForm] = useState(false);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [isLoadingData, setIsLoadingData] = useState(false); // For data loading state
  
  useEffect(() => {
    const adminSessionActive = sessionStorage.getItem('adminSessionActive');
    if (adminSessionActive === 'true') {
      setIsLoggedIn(true);
      loadDashboardData();
    }
  }, []);
  
  const loadDashboardData = async () => {
    setIsLoadingData(true);
    setError('');
    try {
      // Use the new RPC for funnel stats if you switched getFunnelStats in supabase.js
      // or ensure getFunnelStats() fetches from the new view or RPC.
      const statsResult = await getFunnelStats(); // This should now fetch from get_funnel_stats_data() or similar
      const metricsResult = await getMonthlyMetrics();
      
      setFunnelStatsData(statsResult || []);
      setMetrics(metricsResult || []);
    } catch (err) {
      console.error('Error loading dashboard data:', err);
      setError('Failed to load dashboard data. Please try refreshing.');
    } finally {
      setIsLoadingData(false);
    }
  };
  
  const handleLogin = async (e) => {
    e.preventDefault();
    setError('');
    setIsLoggingIn(true);
    
    try {
      // Call the Supabase Edge Function to verify the admin password
      const { data, error: funcError } = await supabase.functions.invoke('verify-admin', {
        body: { accessCode: password },
      });

      if (funcError) {
        console.error('Edge Function invocation error:', funcError);
        setError(funcError.message || 'Error calling verification service.');
        setIsLoggingIn(false);
        return;
      }

      if (data && data.success) {
        sessionStorage.setItem('adminSessionActive', 'true');
        setIsLoggedIn(true);
        await loadDashboardData();
      } else {
        setError(data.message || 'Invalid password or access denied.');
      }
    } catch (err) {
      console.error('Error during login:', err);
      setError('An unexpected error occurred during login. Please try again.');
    } finally {
      setIsLoggingIn(false);
      setPassword(''); // Clear password field
    }
  };
  
  const handleLogout = () => {
    sessionStorage.removeItem('adminSessionActive');
    setIsLoggedIn(false);
    // Optionally clear other states
    setFunnelStatsData([]);
    setMetrics([]);
    setActiveTab('dashboard');
  };
  
  const handleAddOrUpdateMetrics = async (metricData) => {
    setError(''); setSuccessMessage('');
    try {
      const result = await updateMonthlyMetrics(metricData);
      if (!result.success) {
        setError(result.message || 'Failed to save metrics.');
        return false;
      }
      await loadDashboardData(); // Reload all data
      setShowMetricsForm(false);
      setSuccessMessage('Monthly metrics saved successfully!');
      setTimeout(() => setSuccessMessage(''), 5000);
      return true;
    } catch (err) {
      console.error('Error saving metrics:', err);
      setError('An unexpected error occurred while saving metrics.');
      return false;
    }
  };
  
  const handleDeleteMetric = async (month) => {
    setError(''); setSuccessMessage('');
    if (!window.confirm(`Are you sure you want to delete metrics for ${new Date(month + 'T00:00:00').toLocaleDateString('en-AU', { month: 'long', year: 'numeric' })}?`)) {
        return;
    }
    try {
      const result = await deleteMonthlyMetrics(month);
      if (!result.success) {
        setError(result.message || 'Failed to delete metrics.');
        return;
      }
      await loadDashboardData(); // Reload all data
      setSuccessMessage('Monthly metrics deleted successfully!');
      setTimeout(() => setSuccessMessage(''), 5000);
    } catch (err) {
      console.error('Error deleting metrics:', err);
      setError('An unexpected error occurred while deleting metrics.');
    }
  };
  
  const clearMessages = () => {
    setError('');
    setSuccessMessage('');
  };
  
  if (!isLoggedIn) {
    return (
      <div className="admin-page-container"> {/* Use a more specific class if Layout is not used */}
        <div className="login-container">
          <h2 className="login-title">Spicy Margarita Funnel Dashboard</h2>
          {error && (
            <div className="alert alert-error">
              <span>{error}</span>
              <button onClick={() => setError('')} className="alert-dismiss">Dismiss</button>
            </div>
          )}
          <form onSubmit={handleLogin}>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              placeholder="Enter admin password"
              className="login-input"
              required
              autoFocus
            />
            <button 
              type="submit" 
              className="login-button"
              disabled={isLoggingIn}
            >
              {isLoggingIn ? 'Logging in...' : 'Log In'}
            </button>
          </form>
        </div>
      </div>
    );
  }
  
  return (
    <div className="admin-container"> {/* Main container for the admin page */}
      <div className="admin-header">
        <h1 className="admin-title">Spicy Margarita Funnel Dashboard</h1>
        <div className="tab-navigation">
          {['dashboard', 'stats', 'table'].map(tabName => (
            <button
              key={tabName}
              className={`tab-button ${activeTab === tabName ? 'active' : ''}`}
              onClick={() => { setActiveTab(tabName); clearMessages(); }}
            >
              {tabName.charAt(0).toUpperCase() + tabName.slice(1)}
            </button>
          ))}
          <button 
            onClick={handleLogout}
            className="logout-button"
          >
            Log Out
          </button>
        </div>
      </div>
      
      <div className="admin-content">
        {error && (
          <div className="alert alert-error">
            <span>{error}</span>
            <button onClick={() => setError('')} className="alert-dismiss">Dismiss</button>
          </div>
        )}
        {successMessage && (
          <div className="alert alert-success">
            <span>{successMessage}</span>
            <button onClick={() => setSuccessMessage('')} className="alert-dismiss">Dismiss</button>
          </div>
        )}
        
        {isLoadingData ? (
          <div className="loading-container">
            <div className="loading-spinner"></div>
            <p>Loading dashboard data...</p>
          </div>
        ) : (
          <>
            {activeTab === 'dashboard' && (
              <MetricsDashboard metrics={metrics} />
            )}
            {activeTab === 'stats' && (
              // Pass funnelStatsData to the renamed component
              <FunnelStatsComponent stats={funnelStatsData} /> 
            )}
            {activeTab === 'table' && (
              <div className="table-section">
                {!showMetricsForm && (
                     <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                        <h3 className="table-title" style={{ margin: 0 }}>Monthly Metrics Data</h3>
                        <button 
                            onClick={() => { setShowMetricsForm(true); clearMessages(); }}
                            className="add-month-button"
                        >
                            Add New Month
                        </button>
                    </div>
                )}
                {showMetricsForm ? (
                  <MetricsForm 
                    onSubmit={handleAddOrUpdateMetrics}
                    onCancel={() => { setShowMetricsForm(false); clearMessages(); }}
                    existingMetrics={metrics} // Pass existing metrics to check for duplicates
                  />
                ) : (
                  <MetricsTable 
                    metrics={metrics} 
                    onDeleteMetric={handleDeleteMetric}
                  />
                )}
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
}

================
File: src/pages/ConfirmPage.jsx
================
import React from 'react';
import { useParams, Navigate } from 'react-router-dom';
import Layout from '../components/common/Layout';
import VisitConfirm from '../components/confirm/VisitConfirm';

export default function ConfirmPage() {
  const { token } = useParams();
  
  // Redirect to landing page if no token
  if (!token) {
    return <Navigate to="/" replace />;
  }
  
  return (
    <Layout>
      <div className="confirm-page">
        <VisitConfirm />
      </div>
    </Layout>
  );
}

================
File: src/pages/LandingPage.jsx
================
import React from 'react';
import Layout from '../components/common/Layout';
import LandingForm from '../components/landing/LandingForm';

export default function LandingPage() {
  return (
    <Layout>
      <div className="landing-page">
        <div className="hero-section">

        </div>
        <LandingForm />
      </div>
    </Layout>
  );
}

================
File: src/pages/VoucherPage.jsx
================
import React from 'react';
import { useSearchParams, Navigate } from 'react-router-dom';
import Layout from '../components/common/Layout';
import VoucherForm from '../components/voucher/VoucherForm';

export default function VoucherPage() {
  const [searchParams] = useSearchParams();
  const token = searchParams.get('token');
  
  // Redirect to landing page if no token
  if (!token) {
    return <Navigate to="/" replace />;
  }
  
  return (
    <Layout>
      <div className="voucher-page">
        <VoucherForm />
      </div>
    </Layout>
  );
}

================
File: supabase/.gitignore
================
# Supabase
.branches
.temp

# dotenvx
.env.keys
.env.local
.env.*.local

================
File: supabase/config.toml
================
# For detailed configuration reference documentation, visit:
# https://supabase.com/docs/guides/local-development/cli/config
# A string used to distinguish different Supabase projects on the same host. Defaults to the
# working directory name when running `supabase init`.
project_id = "spicy_margarita_funnel"

[api]
enabled = true
# Port to use for the API URL.
port = 54321
# Schemas to expose in your API. Tables, views and stored procedures in this schema will get API
# endpoints. `public` and `graphql_public` schemas are included by default.
schemas = ["public", "graphql_public"]
# Extra schemas to add to the search_path of every request.
extra_search_path = ["public", "extensions"]
# The maximum number of rows returns from a view, table, or stored procedure. Limits payload size
# for accidental or malicious requests.
max_rows = 1000

[api.tls]
# Enable HTTPS endpoints locally using a self-signed certificate.
enabled = false

[db]
# Port to use for the local database URL.
port = 54322
# Port used by db diff command to initialize the shadow database.
shadow_port = 54320
# The database major version to use. This has to be the same as your remote database's. Run `SHOW
# server_version;` on the remote database to check.
major_version = 15

[db.pooler]
enabled = false
# Port to use for the local connection pooler.
port = 54329
# Specifies when a server connection can be reused by other clients.
# Configure one of the supported pooler modes: `transaction`, `session`.
pool_mode = "transaction"
# How many server connections to allow per user/database pair.
default_pool_size = 20
# Maximum number of client connections allowed.
max_client_conn = 100

# [db.vault]
# secret_key = "env(SECRET_VALUE)"

[db.migrations]
# Specifies an ordered list of schema files that describe your database.
# Supports glob patterns relative to supabase directory: "./schemas/*.sql"
schema_paths = []

[db.seed]
# If enabled, seeds the database after migrations during a db reset.
enabled = true
# Specifies an ordered list of seed files to load during db reset.
# Supports glob patterns relative to supabase directory: "./seeds/*.sql"
sql_paths = ["./seed.sql"]

[realtime]
enabled = true
# Bind realtime via either IPv4 or IPv6. (default: IPv4)
# ip_version = "IPv6"
# The maximum length in bytes of HTTP request headers. (default: 4096)
# max_header_length = 4096

[studio]
enabled = true
# Port to use for Supabase Studio.
port = 54323
# External URL of the API server that frontend connects to.
api_url = "http://127.0.0.1"
# OpenAI API Key to use for Supabase AI in the Supabase Studio.
openai_api_key = "env(OPENAI_API_KEY)"

# Email testing server. Emails sent with the local dev setup are not actually sent - rather, they
# are monitored, and you can view the emails that would have been sent from the web interface.
[inbucket]
enabled = true
# Port to use for the email testing server web interface.
port = 54324
# Uncomment to expose additional ports for testing user applications that send emails.
# smtp_port = 54325
# pop3_port = 54326
# admin_email = "admin@email.com"
# sender_name = "Admin"

[storage]
enabled = true
# The maximum file size allowed (e.g. "5MB", "500KB").
file_size_limit = "50MiB"

# Image transformation API is available to Supabase Pro plan.
# [storage.image_transformation]
# enabled = true

# Uncomment to configure local storage buckets
# [storage.buckets.images]
# public = false
# file_size_limit = "50MiB"
# allowed_mime_types = ["image/png", "image/jpeg"]
# objects_path = "./images"

[auth]
enabled = true
# The base URL of your website. Used as an allow-list for redirects and for constructing URLs used
# in emails.
site_url = "http://127.0.0.1:3000"
# A list of *exact* URLs that auth providers are permitted to redirect to post authentication.
additional_redirect_urls = ["https://127.0.0.1:3000"]
# How long tokens are valid for, in seconds. Defaults to 3600 (1 hour), maximum 604,800 (1 week).
jwt_expiry = 3600
# If disabled, the refresh token will never expire.
enable_refresh_token_rotation = true
# Allows refresh tokens to be reused after expiry, up to the specified interval in seconds.
# Requires enable_refresh_token_rotation = true.
refresh_token_reuse_interval = 10
# Allow/disallow new user signups to your project.
enable_signup = true
# Allow/disallow anonymous sign-ins to your project.
enable_anonymous_sign_ins = false
# Allow/disallow testing manual linking of accounts
enable_manual_linking = false
# Passwords shorter than this value will be rejected as weak. Minimum 6, recommended 8 or more.
minimum_password_length = 6
# Passwords that do not meet the following requirements will be rejected as weak. Supported values
# are: `letters_digits`, `lower_upper_letters_digits`, `lower_upper_letters_digits_symbols`
password_requirements = ""

[auth.rate_limit]
# Number of emails that can be sent per hour. Requires auth.email.smtp to be enabled.
email_sent = 2
# Number of SMS messages that can be sent per hour. Requires auth.sms to be enabled.
sms_sent = 30
# Number of anonymous sign-ins that can be made per hour per IP address. Requires enable_anonymous_sign_ins = true.
anonymous_users = 30
# Number of sessions that can be refreshed in a 5 minute interval per IP address.
token_refresh = 150
# Number of sign up and sign-in requests that can be made in a 5 minute interval per IP address (excludes anonymous users).
sign_in_sign_ups = 30
# Number of OTP / Magic link verifications that can be made in a 5 minute interval per IP address.
token_verifications = 30

# Configure one of the supported captcha providers: `hcaptcha`, `turnstile`.
# [auth.captcha]
# enabled = true
# provider = "hcaptcha"
# secret = ""

[auth.email]
# Allow/disallow new user signups via email to your project.
enable_signup = true
# If enabled, a user will be required to confirm any email change on both the old, and new email
# addresses. If disabled, only the new email is required to confirm.
double_confirm_changes = true
# If enabled, users need to confirm their email address before signing in.
enable_confirmations = false
# If enabled, users will need to reauthenticate or have logged in recently to change their password.
secure_password_change = false
# Controls the minimum amount of time that must pass before sending another signup confirmation or password reset email.
max_frequency = "1s"
# Number of characters used in the email OTP.
otp_length = 6
# Number of seconds before the email OTP expires (defaults to 1 hour).
otp_expiry = 3600

# Use a production-ready SMTP server
# [auth.email.smtp]
# enabled = true
# host = "smtp.sendgrid.net"
# port = 587
# user = "apikey"
# pass = "env(SENDGRID_API_KEY)"
# admin_email = "admin@email.com"
# sender_name = "Admin"

# Uncomment to customize email template
# [auth.email.template.invite]
# subject = "You have been invited"
# content_path = "./supabase/templates/invite.html"

[auth.sms]
# Allow/disallow new user signups via SMS to your project.
enable_signup = false
# If enabled, users need to confirm their phone number before signing in.
enable_confirmations = false
# Template for sending OTP to users
template = "Your code is {{ .Code }}"
# Controls the minimum amount of time that must pass before sending another sms otp.
max_frequency = "5s"

# Use pre-defined map of phone number to OTP for testing.
# [auth.sms.test_otp]
# 4152127777 = "123456"

# Configure logged in session timeouts.
# [auth.sessions]
# Force log out after the specified duration.
# timebox = "24h"
# Force log out if the user has been inactive longer than the specified duration.
# inactivity_timeout = "8h"

# This hook runs before a token is issued and allows you to add additional claims based on the authentication method used.
# [auth.hook.custom_access_token]
# enabled = true
# uri = "pg-functions://<database>/<schema>/<hook_name>"

# Configure one of the supported SMS providers: `twilio`, `twilio_verify`, `messagebird`, `textlocal`, `vonage`.
[auth.sms.twilio]
enabled = false
account_sid = ""
message_service_sid = ""
# DO NOT commit your Twilio auth token to git. Use environment variable substitution instead:
auth_token = "env(SUPABASE_AUTH_SMS_TWILIO_AUTH_TOKEN)"

# Multi-factor-authentication is available to Supabase Pro plan.
[auth.mfa]
# Control how many MFA factors can be enrolled at once per user.
max_enrolled_factors = 10

# Control MFA via App Authenticator (TOTP)
[auth.mfa.totp]
enroll_enabled = false
verify_enabled = false

# Configure MFA via Phone Messaging
[auth.mfa.phone]
enroll_enabled = false
verify_enabled = false
otp_length = 6
template = "Your code is {{ .Code }}"
max_frequency = "5s"

# Configure MFA via WebAuthn
# [auth.mfa.web_authn]
# enroll_enabled = true
# verify_enabled = true

# Use an external OAuth provider. The full list of providers are: `apple`, `azure`, `bitbucket`,
# `discord`, `facebook`, `github`, `gitlab`, `google`, `keycloak`, `linkedin_oidc`, `notion`, `twitch`,
# `twitter`, `slack`, `spotify`, `workos`, `zoom`.
[auth.external.apple]
enabled = false
client_id = ""
# DO NOT commit your OAuth provider secret to git. Use environment variable substitution instead:
secret = "env(SUPABASE_AUTH_EXTERNAL_APPLE_SECRET)"
# Overrides the default auth redirectUrl.
redirect_uri = ""
# Overrides the default auth provider URL. Used to support self-hosted gitlab, single-tenant Azure,
# or any other third-party OIDC providers.
url = ""
# If enabled, the nonce check will be skipped. Required for local sign in with Google auth.
skip_nonce_check = false

# Use Firebase Auth as a third-party provider alongside Supabase Auth.
[auth.third_party.firebase]
enabled = false
# project_id = "my-firebase-project"

# Use Auth0 as a third-party provider alongside Supabase Auth.
[auth.third_party.auth0]
enabled = false
# tenant = "my-auth0-tenant"
# tenant_region = "us"

# Use AWS Cognito (Amplify) as a third-party provider alongside Supabase Auth.
[auth.third_party.aws_cognito]
enabled = false
# user_pool_id = "my-user-pool-id"
# user_pool_region = "us-east-1"

# Use Clerk as a third-party provider alongside Supabase Auth.
[auth.third_party.clerk]
enabled = false
# Obtain from https://clerk.com/setup/supabase
# domain = "example.clerk.accounts.dev"

[edge_runtime]
enabled = true
# Configure one of the supported request policies: `oneshot`, `per_worker`.
# Use `oneshot` for hot reload, or `per_worker` for load testing.
policy = "oneshot"
# Port to attach the Chrome inspector for debugging edge functions.
inspector_port = 8083
# The Deno major version to use.
deno_version = 1

# [edge_runtime.secrets]
# secret_key = "env(SECRET_VALUE)"

[analytics]
enabled = true
port = 54327
# Configure one of the supported backends: `postgres`, `bigquery`.
backend = "postgres"

# Experimental features may be deprecated any time
[experimental]
# Configures Postgres storage engine to use OrioleDB (S3)
orioledb_version = ""
# Configures S3 bucket URL, eg. <bucket_name>.s3-<region>.amazonaws.com
s3_host = "env(S3_HOST)"
# Configures S3 bucket region, eg. us-east-1
s3_region = "env(S3_REGION)"
# Configures AWS_ACCESS_KEY_ID for S3 bucket
s3_access_key = "env(S3_ACCESS_KEY)"
# Configures AWS_SECRET_ACCESS_KEY for S3 bucket
s3_secret_key = "env(S3_SECRET_KEY)"

================
File: supabase/functions/aggregate-monthly-metrics/index.ts
================
// supabase/functions/aggregate-monthly-metrics/index.ts
import { createClient, SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2.39.7';

console.log("[aggregate-monthly-metrics] Function script starting.");

// Environment variables for the Supabase client
const supabaseUrl = Deno.env.get('SUPABASE_URL');
const serviceRoleKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');

export const corsHeaders = {
  'Access-Control-Allow-Origin': '*', // Or specific origin if needed
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
};

interface MonthlyCounts {
  new_leads_generated_this_month: number;
  vouchers_claimed_this_month: number; // Users who reached stage 1 THIS month
  first_visits_this_month: number;
  second_visits_this_month: number;
  third_visits_this_month: number;
}

Deno.serve(async (req: Request) => {
  console.log(`[aggregate-monthly-metrics] Request received: ${req.method}`);

  if (req.method === 'OPTIONS') {
    return new Response(null, { status: 204, headers: corsHeaders });
  }

  // Secure this function: only allow calls from a trusted source (e.g., cron job, specific auth)
  // For simplicity here, we'll assume it's callable, but in production, add auth.
  // const authHeader = req.headers.get('Authorization');
  // if (authHeader !== `Bearer ${Deno.env.get('CRON_JOB_SECRET')}`) {
  //   return new Response(JSON.stringify({ error: 'Unauthorized' }), { status: 401 });
  // }


  if (!supabaseUrl || !serviceRoleKey) {
    console.error("[aggregate-monthly-metrics] Missing Supabase URL or Service Role Key in environment variables.");
    return new Response(JSON.stringify({ error: 'Server configuration error.' }), { status: 500 });
  }

  const supabaseAdminClient = createClient(supabaseUrl, serviceRoleKey);

  let targetDateInput: string | null = null;
  if (req.method === 'POST') {
    try {
      const body = await req.json();
      targetDateInput = body.targetDate; // Expects YYYY-MM-DD format for start of month
    } catch (e) {
      console.warn("[aggregate-monthly-metrics] Could not parse POST body for targetDate, will use previous month.");
    }
  }
  
  let forMonthStart: Date;
  if (targetDateInput && /^\d{4}-\d{2}-\d{2}$/.test(targetDateInput)) {
    forMonthStart = new Date(targetDateInput + "T00:00:00.000Z"); // Treat as UTC start of day
  } else {
    // Default to the start of the previous month
    const today = new Date();
    forMonthStart = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth() - 1, 1));
  }

  const forMonthEnd = new Date(Date.UTC(forMonthStart.getUTCFullYear(), forMonthStart.getUTCMonth() + 1, 1));
  const monthKey = forMonthStart.toISOString().split('T')[0]; // YYYY-MM-DD

  console.log(`[aggregate-monthly-metrics] Aggregating metrics for month starting: ${monthKey}`);

  try {
    const counts: MonthlyCounts = {
      new_leads_generated_this_month: 0,
      vouchers_claimed_this_month: 0,
      first_visits_this_month: 0,
      second_visits_this_month: 0,
      third_visits_this_month: 0,
    };

    // 1. New Leads Generated This Month
    const { count: newLeadsCount, error: newLeadsError } = await supabaseAdminClient
      .from('guests')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', forMonthStart.toISOString())
      .lt('created_at', forMonthEnd.toISOString());
    if (newLeadsError) throw new Error(`Error fetching new leads: ${newLeadsError.message}`);
    counts.new_leads_generated_this_month = newLeadsCount || 0;
    console.log(`New leads for ${monthKey}: ${counts.new_leads_generated_this_month}`);


    // 2. Vouchers Claimed This Month (Guest reached Stage 1 this month)
    // This is the trickiest. We need to identify when they *first* hit stage 1.
    // Assuming 'last_stage_at' is updated upon each stage progression AND 'stage' reflects current stage.
    // We look for guests whose last_stage_at falls in the month AND their current stage is >= 1
    // AND whose previous stage (if recorded or inferred) was 0.
    // A simpler proxy, if your Brevo/DB logic is solid: guests who entered stage 1, and their last_stage_at for that entry is in the month.
    // For now, a simplified approach: guests whose `last_stage_at` is in the month AND whose current stage is 1 (or >1 if they progressed fast)
    // AND whose `created_at` was before or during this month (to avoid counting future leads).
    // This still isn't perfect for "transitioned to stage 1 THIS month".
    // A more robust way would be to have an event log or a specific "voucher_claimed_at" timestamp.
    // Let's use last_stage_at for stage 1 for now, assuming it marks the transition time to stage 1.
    const { count: vouchersClaimedCount, error: vouchersClaimedError } = await supabaseAdminClient
      .from('guests')
      .select('*', { count: 'exact', head: true })
      .eq('stage', 1) // Or .gte('stage', 1) depending on how you want to count if they progressed past stage 1 in same month
      .gte('last_stage_at', forMonthStart.toISOString()) // And this last_stage_at corresponds to reaching stage 1
      .lt('last_stage_at', forMonthEnd.toISOString());
    if (vouchersClaimedError) throw new Error(`Error fetching vouchers claimed: ${vouchersClaimedError.message}`);
    counts.vouchers_claimed_this_month = vouchersClaimedCount || 0;
    console.log(`Vouchers claimed for ${monthKey}: ${counts.vouchers_claimed_this_month}`);


    // 3. Visits This Month
    const visitTypes = [
      { number: 1, key: 'first_visits_this_month' as keyof MonthlyCounts },
      { number: 2, key: 'second_visits_this_month' as keyof MonthlyCounts },
      { number: 3, key: 'third_visits_this_month' as keyof MonthlyCounts },
    ];

    for (const visitType of visitTypes) {
      const { count: visitCount, error: visitError } = await supabaseAdminClient
        .from('visits')
        .select('*', { count: 'exact', head: true })
        .eq('visit_number', visitType.number)
        .gte('created_at', forMonthStart.toISOString())
        .lt('created_at', forMonthEnd.toISOString());
      if (visitError) throw new Error(`Error fetching visit number ${visitType.number}: ${visitError.message}`);
      counts[visitType.key] = visitCount || 0;
      console.log(`${visitType.key} for ${monthKey}: ${counts[visitType.key]}`);
    }

    // Prepare data for upsert (only update count fields and calculated SMS cost)
    const calculatedSmsCost = (counts.vouchers_claimed_this_month || 0) * 0.1091;
    const dataToUpsert = {
      month: monthKey,
      new_leads_generated_this_month: counts.new_leads_generated_this_month,
      vouchers_claimed_this_month: counts.vouchers_claimed_this_month,
      first_visits_this_month: counts.first_visits_this_month,
      second_visits_this_month: counts.second_visits_this_month,
      third_visits_this_month: counts.third_visits_this_month,
      stage1_sms_cost: parseFloat(calculatedSmsCost.toFixed(2)), // Ensure it's a number
      // IMPORTANT: We are NOT updating ad_spend, COGS, revenue here. Those remain manual.
    };

    console.log(`[aggregate-monthly-metrics] Upserting data for ${monthKey}:`, dataToUpsert);
    const { error: upsertError } = await supabaseAdminClient
      .from('monthly_metrics')
      .upsert(dataToUpsert, { onConflict: 'month' });

    if (upsertError) {
      console.error("[aggregate-monthly-metrics] Error upserting monthly metrics:", upsertError.message);
      throw new Error(`Error upserting monthly metrics: ${upsertError.message}`);
    }

    console.log(`[aggregate-monthly-metrics] Successfully aggregated and saved metrics for ${monthKey}.`);
    return new Response(JSON.stringify({ success: true, message: `Metrics aggregated for ${monthKey}`, aggregatedData: dataToUpsert }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });

  } catch (error) {
    console.error("[aggregate-monthly-metrics] Error in handler:", error.message, error.stack);
    return new Response(JSON.stringify({ success: false, error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }
});

console.log("[aggregate-monthly-metrics] Function script loaded.");

================
File: supabase/functions/verify-admin/index.ts
================
// supabase/functions/verify-admin/index.ts

import { createClient, SupabaseClient } from 'https://esm.sh/@supabase/supabase-js@2.39.7';
import bcryptjs from 'https://esm.sh/bcryptjs@2.4.3'; // Import the default export from bcryptjs

console.log("[verify-admin] Function script starting to load/execute...");

const supabaseUrlFromEnv = Deno.env.get('SUPABASE_URL');
const supabaseServiceRoleKeyFromEnv = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
const adminHashedPasswordFromEnv = Deno.env.get('ADMIN_HASHED_PASSWORD');

console.log(`[verify-admin] SUPABASE_URL: ${supabaseUrlFromEnv ? `Loaded (starts with: ${supabaseUrlFromEnv.substring(0, 20)}...)` : 'NOT LOADED - CRITICAL!'}`);
console.log(`[verify-admin] SUPABASE_SERVICE_ROLE_KEY: ${supabaseServiceRoleKeyFromEnv ? `Loaded (key length: ${supabaseServiceRoleKeyFromEnv.length}, starts with: ${supabaseServiceRoleKeyFromEnv.substring(0, 5)}...)` : 'NOT LOADED - CRITICAL FOR RPC!'}`);
console.log(`[verify-admin] ADMIN_HASHED_PASSWORD: ${adminHashedPasswordFromEnv ? `Loaded (hash starts with: ${adminHashedPasswordFromEnv.substring(0, 10)}...)` : 'NOT LOADED - CRITICAL!'}`);

export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

Deno.serve(async (req: Request) => {
  const requestUrl = new URL(req.url);
  console.log(`[verify-admin] Request received: ${req.method} ${requestUrl.pathname}`);

  if (req.method === 'OPTIONS') {
    console.log("[verify-admin] Handling OPTIONS request.");
    return new Response(null, { status: 204, headers: corsHeaders });
  }

  if (req.method !== 'POST') {
    console.log(`[verify-admin] Method not allowed: ${req.method}`);
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });
  }

  try {
    console.log("[verify-admin] Processing POST request...");

    const supabaseUrl = Deno.env.get('SUPABASE_URL');
    const supabaseKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
    const adminHashedPassword = Deno.env.get('ADMIN_HASHED_PASSWORD');

    if (!supabaseUrl || !supabaseKey || !adminHashedPassword) {
        console.error("[verify-admin] CRITICAL ERROR: Required environment variables missing within handler.");
        return new Response(JSON.stringify({ success: false, message: 'Server configuration error: Secrets missing.' }), 
            { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
    }
    console.log("[verify-admin] All critical environment variables loaded within handler.");

    let accessCode: string | undefined;
    try {
        const body = await req.json();
        accessCode = body.accessCode;
        console.log("[verify-admin] Parsed request body. Access Code received:", accessCode ? "Exists" : "Missing");
    } catch (jsonError) {
        console.error("[verify-admin] Error parsing JSON body:", jsonError.message);
        return new Response(JSON.stringify({ success: false, message: 'Invalid JSON payload.' }), 
            { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
    }
    
    if (!accessCode) {
      console.log("[verify-admin] Access code is missing.");
      return new Response(JSON.stringify({ success: false, message: 'Access code is required' }), 
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
    }

    console.log("[verify-admin] Comparing provided access code with stored hash using bcryptjs.compare...");
    // Use bcryptjs directly as it's the default export containing the methods
    const isMatch = await bcryptjs.compare(accessCode, adminHashedPassword); 
    
    if (!isMatch) {
      console.log("[verify-admin] Password comparison: No match. Invalid access code.");
      return new Response(JSON.stringify({ success: false, message: 'Invalid access code' }), 
        { status: 401, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
    }

    console.log("[verify-admin] Password comparison: Match! Access granted. Attempting to log access...");
    
    let supabaseClient: SupabaseClient | null = null;
    try {
      supabaseClient = createClient(supabaseUrl, supabaseKey);
      console.log("[verify-admin] Supabase client initialized for RPC call.");
    } catch(clientError) {
        console.error("[verify-admin] Error initializing Supabase client for RPC:", clientError.message);
    }

    if (supabaseClient) {
        try {
            const { error: rpcError } = await supabaseClient.rpc('log_admin_access');
            if (rpcError) {
                console.error("[verify-admin] Error calling 'log_admin_access' RPC:", rpcError.message);
            } else {
                console.log("[verify-admin] 'log_admin_access' RPC called successfully.");
            }
        } catch (rpcCatchError) {
            console.error("[verify-admin] Exception during 'log_admin_access' RPC call:", rpcCatchError.message);
        }
    } else {
        console.warn("[verify-admin] Supabase client for RPC was not initialized. Skipping log_admin_access.");
    }
    
    console.log("[verify-admin] Returning success response.");
    return new Response(JSON.stringify({ success: true, message: 'Access granted' }), 
      { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });

  } catch (error) {
    console.error("[verify-admin] UNHANDLED ERROR in POST request handler:", error.message, error.stack);
    return new Response(JSON.stringify({ success: false, message: error.message || 'Internal server error' }), 
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } });
  }
});

console.log("[verify-admin] Function script loaded. Deno.serve is configured.");

================
File: supabase/schema.sql
================
-- Database schema for Spicy Margarita Funnel application

-- Drop dependent views first if they exist and depend on monthly_metrics
DROP VIEW IF EXISTS public.funnel_profitability; -- If this view exists and uses old monthly_metrics
DROP VIEW IF EXISTS public.funnel_stats; -- Recreate this later with Stage 4

-- Drop existing tables if they exist to apply changes (or use ALTER TABLE carefully for data preservation)
DROP TABLE IF EXISTS public.visits;
DROP TABLE IF EXISTS public.phone_otps;
DROP TABLE IF EXISTS public.monthly_metrics; -- Dropping before guests if there were FKs, though not in your original
DROP TABLE IF EXISTS public.guests;


-- Guests table: Stores all customer information
CREATE TABLE public.guests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email TEXT UNIQUE NOT NULL,
    dob DATE NOT NULL,                  -- Must be 18+
    phone TEXT UNIQUE,
    full_name TEXT,
    stage INTEGER DEFAULT 0,            -- 0=Lead, 1=VoucherClaimed, 2=FirstVisit(SpicyMarg), 3=SecondVisit(IceyMarg), 4=ThirdVisit(FunnelComplete)
    created_at TIMESTAMPTZ DEFAULT now(),
    last_stage_at TIMESTAMPTZ DEFAULT now(), -- Timestamp of the last stage update
    marketing_opt_in BOOLEAN DEFAULT true,
    sms_opt_out BOOLEAN DEFAULT false
);

-- Phone OTP table: For SMS verification
CREATE TABLE public.phone_otps (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    guest_id UUID REFERENCES public.guests(id) ON DELETE CASCADE,
    otp_code CHAR(6) NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Visits table: Records each in-venue visit
CREATE TABLE public.visits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    guest_id UUID REFERENCES public.guests(id) ON DELETE CASCADE,
    visit_number INTEGER NOT NULL,      -- 1 (Spicy Marg), 2 (Icey Marg), or 3 (House Cocktail)
    created_at TIMESTAMPTZ DEFAULT now()
);

-- Monthly metrics: For manually entering aggregated data
CREATE TABLE public.monthly_metrics (
    month DATE PRIMARY KEY,             -- e.g., 2025-04-01

    -- Pre-Funnel
    total_ad_impressions NUMERIC DEFAULT 0,
    total_ad_clicks NUMERIC DEFAULT 0,
    stage0_ad_spend NUMERIC DEFAULT 0,

    -- In-Funnel (Counts - these represent transitions/achievements *within* the month)
    new_leads_generated_this_month NUMERIC DEFAULT 0,       -- New signups (Stage 0) this month
    vouchers_claimed_this_month NUMERIC DEFAULT 0,    -- Verified phone for spicy marg (Stage 1) this month
    first_visits_this_month NUMERIC DEFAULT 0,        -- Redeemed spicy marg (Stage 2) this month
    second_visits_this_month NUMERIC DEFAULT 0,       -- Redeemed icey marg (Stage 3) this month
    third_visits_this_month NUMERIC DEFAULT 0,        -- Redeemed house cocktail (Stage 4 - funnel complete) this month

    -- In-Funnel (Costs/Revenue)
    stage1_cogs NUMERIC DEFAULT 0,                    -- COGS for spicy margarita (Visit 1)
    stage1_sms_cost NUMERIC DEFAULT 0,                -- SMS cost (auto-calculated: vouchers_claimed_this_month * 0.1091)
    stage2_cogs NUMERIC DEFAULT 0,                    -- COGS for icey margarita (Visit 2)
    stage3_cogs NUMERIC DEFAULT 0,                    -- COGS for house cocktail (Visit 3)
    total_revenue_from_funnel_this_month NUMERIC DEFAULT 0,

    notes TEXT
);

-- Create function for age validation
CREATE OR REPLACE FUNCTION is_adult(birth_date DATE) 
RETURNS BOOLEAN AS $$
BEGIN
    RETURN (birth_date + INTERVAL '18 years') <= CURRENT_DATE;
END;
$$ LANGUAGE plpgsql;


-- Create RPC functions for the frontend to call

-- 1. Sign up a new lead (landing page)
CREATE OR REPLACE FUNCTION public.signup_lead(
    p_email TEXT,
    p_dob DATE
) RETURNS jsonb AS $$ -- Changed to jsonb for consistency
DECLARE
    v_guest_id UUID;
    v_created BOOLEAN;
BEGIN
    IF (p_dob + INTERVAL '18 years') > CURRENT_DATE THEN
        RETURN jsonb_build_object(
            'success', false,
            'message', 'You must be at least 18 years old to sign up',
            'guest_id', null,
            'new_signup', false
        );
    END IF;
    
    INSERT INTO public.guests (email, dob, stage, created_at, last_stage_at)
    VALUES (p_email, p_dob, 0, now(), now())
    ON CONFLICT (email) DO NOTHING
    RETURNING id INTO v_guest_id;
    
    v_created := FOUND;
    
    IF NOT v_created THEN
        SELECT id INTO v_guest_id FROM public.guests WHERE email = p_email;
        -- Optionally, update last_stage_at or other fields if re-engaging an existing lead
        -- For now, we just return the existing guest_id
        RETURN jsonb_build_object(
            'success', true, 
            'guest_id', v_guest_id,
            'new_signup', false,
            'message', 'Welcome back! Proceed to the next step.' -- Or a different message
        );
    END IF;
    
    RETURN jsonb_build_object(
        'success', true, 
        'guest_id', v_guest_id,
        'new_signup', v_created,
        'message', 'Signup successful! Check your email.'
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2. Send OTP to phone
CREATE OR REPLACE FUNCTION public.send_otp(
    p_guest_id UUID,
    p_phone TEXT
) RETURNS json AS $$
DECLARE
    v_otp CHAR(6);
    v_expires_at TIMESTAMPTZ;
    v_guest_exists BOOLEAN;
    v_phone_in_use_by_other BOOLEAN;
BEGIN
    SELECT EXISTS(SELECT 1 FROM public.guests WHERE id = p_guest_id) INTO v_guest_exists;
    IF NOT v_guest_exists THEN
        RETURN json_build_object('success', false, 'message', 'Guest not found');
    END IF;
    
    IF p_phone IS NOT NULL THEN
        SELECT EXISTS(SELECT 1 FROM public.guests WHERE phone = p_phone AND id != p_guest_id) INTO v_phone_in_use_by_other;
        IF v_phone_in_use_by_other THEN
            RETURN json_build_object('success', false, 'message', 'Phone number already in use by another account.');
        END IF;
        UPDATE public.guests SET phone = p_phone WHERE id = p_guest_id;
    END IF;
    
    v_otp := lpad(floor(random() * 1000000)::text, 6, '0');
    v_expires_at := now() + interval '10 minutes';
    
    DELETE FROM public.phone_otps WHERE guest_id = p_guest_id;
    INSERT INTO public.phone_otps (guest_id, otp_code, expires_at)
    VALUES (p_guest_id, v_otp, v_expires_at);
    
    RETURN json_build_object('success', true, 'otp', v_otp, 'expires_at', v_expires_at, 'message', 'OTP sent.');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 3. Verify OTP and upgrade to stage 1
CREATE OR REPLACE FUNCTION public.verify_otp(
    p_guest_id UUID,
    p_otp TEXT, -- Ensure it's TEXT to match frontend
    p_full_name TEXT
) RETURNS json AS $$
DECLARE
    v_guest_record public.guests%ROWTYPE;
    v_otp_valid BOOLEAN;
BEGIN
    SELECT * INTO v_guest_record FROM public.guests WHERE id = p_guest_id;
    IF NOT FOUND THEN
        RETURN json_build_object('success', false, 'message', 'Guest not found');
    END IF;

    -- Ensure p_otp is treated as CHAR(6) if it's passed as TEXT
    SELECT EXISTS (
        SELECT 1 FROM public.phone_otps 
        WHERE guest_id = p_guest_id 
        AND otp_code = p_otp -- Direct comparison
        AND expires_at > now()
    ) INTO v_otp_valid;
    
    IF NOT v_otp_valid THEN
        RETURN json_build_object('success', false, 'message', 'Invalid or expired OTP');
    END IF;
    
    UPDATE public.guests 
    SET full_name = p_full_name, 
        stage = 1, 
        last_stage_at = now(),
        phone = COALESCE(v_guest_record.phone, (SELECT po.otp_code FROM public.phone_otps po WHERE po.guest_id = p_guest_id AND po.otp_code = p_otp LIMIT 1)) -- Bit of a hack if phone wasn't set before
    WHERE id = p_guest_id;
    
    DELETE FROM public.phone_otps WHERE guest_id = p_guest_id AND otp_code = p_otp;
    
    RETURN json_build_object(
        'success', true, 
        'message', 'Phone verified! Your Spicy Margarita voucher is active.',
        'guest_id', p_guest_id,
        'full_name', p_full_name,
        'email', v_guest_record.email -- Return email for Brevo updates
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- 4. Confirm visit and advance stage
CREATE OR REPLACE FUNCTION public.confirm_visit(
    p_guest_id UUID,
    p_expected_visit_number INTEGER
) RETURNS json AS $$
DECLARE
    v_guest_record public.guests%ROWTYPE;
    v_actual_next_visit_number INTEGER;
    v_next_stage INTEGER;
BEGIN
    SELECT * INTO v_guest_record FROM public.guests WHERE id = p_guest_id;

    IF NOT FOUND THEN
        RETURN json_build_object(
            'success', false, 'message', 'Guest not found.',
            'email', null, 'stage', null, 'guest_id', p_guest_id, 'full_name', null, 'visit_number', null
        );
    END IF;

    CASE v_guest_record.stage
        WHEN 1 THEN -- Claimed voucher (Stage 1), expecting Spicy Margarita redemption (Visit 1)
            v_actual_next_visit_number := 1; v_next_stage := 2;
        WHEN 2 THEN -- Redeemed Spicy Marg (Stage 2), expecting Icey Margarita redemption (Visit 2)
            v_actual_next_visit_number := 2; v_next_stage := 3;
        WHEN 3 THEN -- Redeemed Icey Marg (Stage 3), expecting House Cocktail redemption (Visit 3)
            v_actual_next_visit_number := 3; v_next_stage := 4; -- Stage 4 is Funnel Complete
        ELSE
            RETURN json_build_object(
                'success', false, 'message', 'Guest is not at a stage eligible for this visit confirmation. Current stage: ' || v_guest_record.stage,
                'email', v_guest_record.email, 'stage', v_guest_record.stage, 'guest_id', p_guest_id, 'full_name', v_guest_record.full_name, 'visit_number', null
            );
    END CASE;

    IF p_expected_visit_number IS NULL OR v_actual_next_visit_number != p_expected_visit_number THEN
        -- Check if this specific expected visit was ALREADY recorded (e.g. user clicks old link)
        IF EXISTS (SELECT 1 FROM public.visits WHERE guest_id = p_guest_id AND visit_number = p_expected_visit_number) THEN
             RETURN json_build_object(
                'success', false, 'message', 'This specific offer (for visit ' || p_expected_visit_number || ') has already been redeemed.',
                'email', v_guest_record.email, 'stage', v_guest_record.stage, 'guest_id', p_guest_id, 'full_name', v_guest_record.full_name, 'visit_number', p_expected_visit_number
             );
        ELSE -- Link is for a visit number that doesn't match current eligibility
             RETURN json_build_object(
                'success', false, 'message', 'Offer link (for visit ' || p_expected_visit_number || ') does not match current guest progress (eligible for visit ' || v_actual_next_visit_number || ' based on stage ' || v_guest_record.stage || ').',
                'email', v_guest_record.email, 'stage', v_guest_record.stage, 'guest_id', p_guest_id, 'full_name', v_guest_record.full_name, 'visit_number', null
             );
        END IF;
    END IF;

    -- If eligible and expected matches, check if this actual_next_visit_number was ALREADY recorded (double-check, defensive)
    IF EXISTS (SELECT 1 FROM public.visits WHERE guest_id = p_guest_id AND visit_number = v_actual_next_visit_number) THEN
        RETURN json_build_object(
            'success', false, 'message', 'This visit (' || v_actual_next_visit_number || ') has already been recorded.',
            'email', v_guest_record.email, 'stage', v_guest_record.stage, 'visit_number', v_actual_next_visit_number, 'guest_id', p_guest_id, 'full_name', v_guest_record.full_name
        );
    END IF;

    INSERT INTO public.visits (guest_id, visit_number, created_at)
    VALUES (p_guest_id, v_actual_next_visit_number, now());

    UPDATE public.guests
    SET stage = v_next_stage, last_stage_at = now()
    WHERE id = p_guest_id;

    RETURN json_build_object(
        'success', true, 'message', 'Visit ' || v_actual_next_visit_number || ' confirmed!',
        'email', v_guest_record.email, 'visit_number', v_actual_next_visit_number, 'stage', v_next_stage, 
        'guest_id', p_guest_id, 'full_name', v_guest_record.full_name
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- 5. Get Guest Status by ID (for VoucherForm)
CREATE OR REPLACE FUNCTION public.get_guest_status_by_id(p_guest_id UUID)
RETURNS json AS $$
DECLARE
    v_guest_record public.guests%ROWTYPE;
BEGIN
    SELECT * INTO v_guest_record FROM public.guests WHERE id = p_guest_id;
    IF NOT FOUND THEN
        RETURN json_build_object('success', false, 'message', 'Guest not found by ID.');
    END IF;

    RETURN json_build_object(
        'success', true,
        'guest', json_build_object(
            'guestId', v_guest_record.id, -- ensure key matches frontend expectations
            'fullName', v_guest_record.full_name,
            'phone', v_guest_record.phone,
            'stage', v_guest_record.stage,
            'email', v_guest_record.email
        )
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;


-- 6. Admin stats view for dashboard (including Stage 4)
CREATE OR REPLACE VIEW public.funnel_stats_overview AS
WITH stage_counts AS (
    SELECT 0 AS stage, COUNT(*) AS count FROM public.guests WHERE stage = 0 UNION ALL
    SELECT 1 AS stage, COUNT(*) AS count FROM public.guests WHERE stage = 1 UNION ALL
    SELECT 2 AS stage, COUNT(*) AS count FROM public.guests WHERE stage = 2 UNION ALL
    SELECT 3 AS stage, COUNT(*) AS count FROM public.guests WHERE stage = 3 UNION ALL
    SELECT 4 AS stage, COUNT(*) AS count FROM public.guests WHERE stage = 4 -- Funnel Complete
),
total_initial_leads AS (
    SELECT COALESCE(NULLIF(COUNT(*), 0), 1) AS total_count FROM public.guests -- Avoid division by zero if no guests
),
conversion_rates AS (
    SELECT
        s1.stage,
        s1.count,
        CASE
            WHEN s1.stage = 0 AND (SELECT total_count FROM total_initial_leads) > 0 THEN 100.00 -- All leads start here
            WHEN s1.stage = 0 AND (SELECT total_count FROM total_initial_leads) = 0 THEN 0.00
            WHEN LAG(s1.count) OVER (ORDER BY s1.stage) = 0 THEN 0.00
            ELSE ROUND((s1.count * 100.0 / LAG(s1.count) OVER (ORDER BY s1.stage))::numeric, 2)
        END AS conversion_from_previous_stage,
        ROUND((s1.count * 100.0 / (SELECT total_count FROM total_initial_leads))::numeric, 2) AS conversion_from_total_leads
    FROM stage_counts s1
)
SELECT 
    cr.stage,
    CASE 
        WHEN cr.stage = 0 THEN 'Leads (Signed Up)'
        WHEN cr.stage = 1 THEN 'Voucher Claimed (Spicy Marg)'
        WHEN cr.stage = 2 THEN '1st Visit (Spicy Marg Redeemed)'
        WHEN cr.stage = 3 THEN '2nd Visit (Icey Marg Redeemed)'
        WHEN cr.stage = 4 THEN '3rd Visit (Funnel Completed)'
    END AS stage_name,
    cr.count,
    cr.conversion_from_previous_stage,
    cr.conversion_from_total_leads
FROM conversion_rates cr
ORDER BY cr.stage;

-- RPC to get funnel stats data (can be used by frontend if preferred over client-side calculation)
CREATE OR REPLACE FUNCTION public.get_funnel_stats_data()
RETURNS JSONB AS $$
DECLARE
    result JSONB;
BEGIN
    SELECT jsonb_agg(t)
    INTO result
    FROM (
        SELECT 
            stage,
            stage_name,
            count,
            conversion_from_previous_stage as conversion_rate -- simpler key for frontend
        FROM public.funnel_stats_overview
    ) t;
    RETURN COALESCE(result, '[]'::jsonb);
END;
$$ LANGUAGE plpgsql STABLE SECURITY DEFINER;


-- Function to log admin access (called by verify-admin Edge Function)
-- You might want an admin_logs table for this.
-- CREATE TABLE IF NOT EXISTS public.admin_access_logs (
--     id BIGSERIAL PRIMARY KEY,
--     accessed_at TIMESTAMPTZ DEFAULT now(),
--     ip_address TEXT -- Can be tricky to get reliably from Edge Function
-- );
-- CREATE OR REPLACE FUNCTION public.log_admin_access()
-- RETURNS VOID AS $$
-- BEGIN
--     INSERT INTO public.admin_access_logs (accessed_at) VALUES (now());
-- END;
-- $$ LANGUAGE plpgsql SECURITY DEFINER;
-- For simplicity, if you don't have the table, the RPC call in edge func will just do nothing or error silently.


-- Set up row level security (RLS)
ALTER TABLE public.guests ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.phone_otps ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.visits ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.monthly_metrics ENABLE ROW LEVEL SECURITY;

-- Policies for guests:
-- Allow anonymous users to insert (for signup_lead RPC which is SECURITY DEFINER)
CREATE POLICY "Enable insert for anonymous users via RPC" ON public.guests FOR INSERT TO anon WITH CHECK (true);
-- Allow authenticated users (admin) to read all guest data for dashboard
CREATE POLICY "Enable read access for authenticated admin" ON public.guests FOR SELECT TO authenticated USING (true);
-- Allow service_role full access (Supabase internal)
CREATE POLICY "Enable full access for service_role" ON public.guests TO service_role USING (true) WITH CHECK (true);


-- Policies for phone_otps:
CREATE POLICY "Enable access for anonymous users via RPC" ON public.phone_otps FOR ALL TO anon USING (true) WITH CHECK (true);
CREATE POLICY "Enable full access for service_role otp" ON public.phone_otps TO service_role USING (true) WITH CHECK (true);


-- Policies for visits:
CREATE POLICY "Enable access for anonymous users via RPC for visits" ON public.visits FOR ALL TO anon USING (true) WITH CHECK (true);
CREATE POLICY "Enable full access for service_role for visits" ON public.visits TO service_role USING (true) WITH CHECK (true);

-- Policies for monthly_metrics:
-- Allow authenticated users (admin) to manage their own metrics.
CREATE POLICY "Authenticated admin can manage monthly_metrics" ON public.monthly_metrics FOR ALL TO authenticated
    USING (true) -- Allows read
    WITH CHECK (true); -- Allows write (insert, update, delete)
CREATE POLICY "Enable full access for service_role for monthly_metrics" ON public.monthly_metrics TO service_role USING (true) WITH CHECK (true);

-- Grant USAGE on schema public to anon and authenticated if not already there
GRANT USAGE ON SCHEMA public TO anon;
GRANT USAGE ON SCHEMA public TO authenticated;

-- Grant EXECUTE on specific functions to anon role (since they are called from client-side anon key)
GRANT EXECUTE ON FUNCTION public.signup_lead(TEXT, DATE) TO anon;
GRANT EXECUTE ON FUNCTION public.send_otp(UUID, TEXT) TO anon;
GRANT EXECUTE ON FUNCTION public.verify_otp(UUID, TEXT, TEXT) TO anon;
GRANT EXECUTE ON FUNCTION public.confirm_visit(UUID, INTEGER) TO anon;
GRANT EXECUTE ON FUNCTION public.get_guest_status_by_id(UUID) TO anon;

-- Grant EXECUTE on functions for authenticated role (admin)
GRANT EXECUTE ON FUNCTION public.get_funnel_stats_data() TO authenticated;
-- GRANT EXECUTE ON FUNCTION public.log_admin_access() TO service_role; -- If using this

-- Grant SELECT on views to authenticated role (admin)
GRANT SELECT ON public.funnel_stats_overview TO authenticated;

================
File: webpack.config.js
================
// webpack.config.js
const webpack = require('webpack');

module.exports = {
  // ... other webpack configuration
  resolve: {
    fallback: {
      // Provide polyfills for Node.js core modules
      "crypto": require.resolve("crypto-browserify"),
      "stream": require.resolve("stream-browserify"),
      "buffer": require.resolve("buffer/"),
      "util": require.resolve("util/"),
      "path": require.resolve("path-browserify"),
      "assert": require.resolve("assert/"),
      "os": require.resolve("os-browserify/browser"),
      "zlib": require.resolve("browserify-zlib"),
      "fs": false, // Not needed in the browser
      "child_process": false, // Not needed in the browser
      "net": false, // Not needed in the browser
      "tls": false, // Not needed in the browser
    },
  },
  plugins: [
    // ... other plugins
    new webpack.ProvidePlugin({
      Buffer: ['buffer', 'Buffer'],
      process: 'process/browser',
    }),
  ],
};

================
File: .gitignore
================
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.js

# testing
/coverage

# production
/build

# misc
.DS_Store
.env.local
.env.development.local
.env.test.local
.env.production.local

npm-debug.log*
yarn-debug.log*
yarn-error.log*

================
File: package.json
================
{
  "name": "spicy_margarita_funnel",
  "version": "0.1.0",
  "private": true,
  "dependencies": {
    "@supabase/supabase-js": "^2.39.7",
    "@testing-library/jest-dom": "^5.17.0",
    "@testing-library/react": "^13.4.0",
    "@testing-library/user-event": "^13.5.0",
    "assert": "^2.1.0",
    "bcryptjs": "^2.4.3",
    "browserify-zlib": "^0.2.0",
    "buffer": "^6.0.3",
    "chart.js": "^4.4.1",
    "crypto-browserify": "^3.12.0",
    "js-sha256": "^0.10.1",
    "os-browserify": "^0.3.0",
    "path-browserify": "^1.0.1",
    "process": "^0.11.10",
    "react": "^18.2.0",
    "react-app-rewired": "^2.2.1",
    "react-chartjs-2": "^5.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.21.3",
    "react-scripts": "5.0.1",
    "stream-browserify": "^3.0.0",
    "url": "^0.11.3",
    "util": "^0.12.5",
    "web-vitals": "^2.1.4"
  },
  "scripts": {
    "start": "react-app-rewired start",
    "build": "react-app-rewired build",
    "test": "react-app-rewired test",
    "eject": "react-scripts eject"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  },
  "devDependencies": {
    "supabase": "^2.22.12",
    "vm-browserify": "^1.1.2"
  }
}

================
File: public/index.html
================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/websiteicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#0d0d0d" />
    <meta
      name="description"
      content="Get a free Spicy Margarita at trap. Cocktail Bar"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/websiteicon_2.ico" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&display=swap" rel="stylesheet">
    <title>trap. | Free Spicy Margarita</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
  </body>
</html>

================
File: public/manifest.json
================
{
  "short_name": "Trap",
  "name": "Trap Cocktail Bar - Free Spicy Margarita",
  "icons": [
    {
      "src": "websiteicon.ico",
      "sizes": "64x64 32x32 24x24 16x16",
      "type": "image/x-icon"
    },
    {
      "src": "websiteicon_2.ico",
      "type": "image/png",
      "sizes": "192x192"
    }
  ],
  "start_url": ".",
  "display": "standalone",
  "theme_color": "#0d0d0d",
  "background_color": "#0d0d0d"
}

================
File: public/robots.txt
================
# https://www.robotstxt.org/robotstxt.html
User-agent: *
Disallow:

================
File: README.md
================
# Getting Started with Create React App

This project was bootstrapped with [Create React App](https://github.com/facebook/create-react-app).

## Available Scripts

In the project directory, you can run:

### `npm start`

Runs the app in the development mode.\
Open [http://localhost:3000](http://localhost:3000) to view it in your browser.

The page will reload when you make changes.\
You may also see any lint errors in the console.

### `npm test`

Launches the test runner in the interactive watch mode.\
See the section about [running tests](https://facebook.github.io/create-react-app/docs/running-tests) for more information.

### `npm run build`

Builds the app for production to the `build` folder.\
It correctly bundles React in production mode and optimizes the build for the best performance.

The build is minified and the filenames include the hashes.\
Your app is ready to be deployed!

See the section about [deployment](https://facebook.github.io/create-react-app/docs/deployment) for more information.

### `npm run eject`

**Note: this is a one-way operation. Once you `eject`, you can't go back!**

If you aren't satisfied with the build tool and configuration choices, you can `eject` at any time. This command will remove the single build dependency from your project.

Instead, it will copy all the configuration files and the transitive dependencies (webpack, Babel, ESLint, etc) right into your project so you have full control over them. All of the commands except `eject` will still work, but they will point to the copied scripts so you can tweak them. At this point you're on your own.

You don't have to ever use `eject`. The curated feature set is suitable for small and middle deployments, and you shouldn't feel obligated to use this feature. However we understand that this tool wouldn't be useful if you couldn't customize it when you are ready for it.

## Learn More

You can learn more in the [Create React App documentation](https://facebook.github.io/create-react-app/docs/getting-started).

To learn React, check out the [React documentation](https://reactjs.org/).

### Code Splitting

This section has moved here: [https://facebook.github.io/create-react-app/docs/code-splitting](https://facebook.github.io/create-react-app/docs/code-splitting)

### Analyzing the Bundle Size

This section has moved here: [https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size](https://facebook.github.io/create-react-app/docs/analyzing-the-bundle-size)

### Making a Progressive Web App

This section has moved here: [https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app](https://facebook.github.io/create-react-app/docs/making-a-progressive-web-app)

### Advanced Configuration

This section has moved here: [https://facebook.github.io/create-react-app/docs/advanced-configuration](https://facebook.github.io/create-react-app/docs/advanced-configuration)

### Deployment

This section has moved here: [https://facebook.github.io/create-react-app/docs/deployment](https://facebook.github.io/create-react-app/docs/deployment)

### `npm run build` fails to minify

This section has moved here: [https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify](https://facebook.github.io/create-react-app/docs/troubleshooting#npm-run-build-fails-to-minify)

================
File: src/App.css
================
.App {
  text-align: center;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  color: #ffffff;
  background-color: #0d0d0d;
}

.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1rem;
}

.main-content {
  flex: 1;
  padding: 2rem 0;
}

/* Apply dark theme to all form elements */
input, select, textarea, button {
  color-scheme: dark;
}

/* Custom scrollbar for dark theme */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #1a1a1a;
}

::-webkit-scrollbar-thumb {
  background: #444;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #555;
}

================
File: src/App.js
================
import React from 'react';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';

// Import pages
import LandingPage from './pages/LandingPage';
import VoucherPage from './pages/VoucherPage';
import ConfirmPage from './pages/ConfirmPage';
import AdminPage from './pages/AdminPage';

// Import CSS
import './App.css';

function App() {
  return (
    <Router>
      <div className="App">
        <Routes>
          <Route path="/" element={<LandingPage />} />
          <Route path="/voucher" element={<VoucherPage />} />
          <Route path="/confirm/:token" element={<ConfirmPage />} />
          <Route path="/admin" element={<AdminPage />} />
          {/* Redirect to landing page for any other route */}
          <Route path="*" element={<LandingPage />} />
        </Routes>
      </div>
    </Router>
  );
}

export default App;

================
File: src/App.test.js
================
import { render, screen } from '@testing-library/react';
import App from './App';

test('renders learn react link', () => {
  render(<App />);
  const linkElement = screen.getByText(/learn react/i);
  expect(linkElement).toBeInTheDocument();
});

================
File: src/index.css
================
/* Import Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap');

/* CSS Reset */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  margin: 0;
  font-family: 'Raleway', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
    'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
    sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  color: #ffffff;
  background-color: #0d0d0d;
  line-height: 1.6;
}

code {
  font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New', monospace;
}

h1, h2, h3, h4, h5, h6 {
  font-family: 'Futura', 'Trebuchet MS', sans-serif;
  font-weight: 700;
  margin-bottom: 1rem;
  color: #ffffff;
}

h1 {
  font-size: 2.5rem;
}

h2 {
  font-size: 2rem;
}

h3 {
  font-size: 1.5rem;
}

p {
  margin-bottom: 1rem;
}

a {
  color: #ff007f;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Form styling */
form {
  margin-bottom: 1rem;
}

.form-group {
  margin-bottom: 1.5rem;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #ffffff;
}

.small-text {
  font-size: 0.8rem;
  color: #aaaaaa;
  margin-top: 0.25rem;
}

.terms-text {
  font-size: 0.8rem;
  color: #aaaaaa;
  margin-top: 1rem;
  text-align: center;
}

textarea {
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  line-height: 1.5;
  color: #ffffff;
  background-color: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

textarea:focus {
  border-color: #ff007f;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(255, 0, 127, 0.25);
}

select {
  display: block;
  width: 100%;
  padding: 12px;
  font-size: 1rem;
  line-height: 1.5;
  color: #ffffff;
  background-color: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ffffff' d='M6 9L0 3h12z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 12px;
}

select:focus {
  border-color: #ff007f;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(255, 0, 127, 0.25);
}

/* Error message */
.error-message {
  background-color: rgba(198, 40, 40, 0.2);
  color: #ff6b6b;
  padding: 0.75rem 1rem;
  margin-bottom: 1rem;
  border-radius: 4px;
  border-left: 4px solid #ff6b6b;
}

/* Success message */
.success-message {
  background-color: rgba(46, 125, 50, 0.2);
  color: #66bb6a;
  padding: 0.75rem 1rem;
  margin-bottom: 1rem;
  border-radius: 4px;
  border-left: 4px solid #66bb6a;
}

/* Page specific styles */
.landing-page {
  max-width: 600px;
  margin: 0 auto;
}

.hero-section {
  text-align: center;
  margin-bottom: 2rem;
}

.hero-tagline {
  font-size: 1.2rem;
  color: #aaaaaa;
}

.landing-form-container,
.voucher-form-container,
.otp-verification-container,
.voucher-display-container,
.success-container,
.admin-login-container,
.visit-confirmation-container {
  background-color: #1a1a1a;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
  padding: 2rem;
}

.tagline {
  font-size: 1.1rem;
  color: #aaaaaa;
  margin-bottom: 1.5rem;
}

/* OTP verification styles */
.otp-inputs {
  display: flex;
  justify-content: center;
  gap: 0.1rem;
  margin: 1.5rem 0;
}

.otp-actions {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.resend-section {
  margin-top: 0.5rem;
}

.countdown-text {
  font-size: 0.9rem;
  color: #aaaaaa;
}

.back-btn {
  margin-top: 1.5rem;
}

/* Voucher display styles */
.voucher-card {
  border: 2px dashed #ff007f;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  background-color: rgba(26, 26, 26, 0.5);
}

.voucher-header {
  text-align: center;
  margin-bottom: 1.5rem;
}

.voucher-code {
  font-family: monospace;
  font-size: 1.2rem;
  background-color: #333;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  display: inline-block;
  margin-top: 0.5rem;
  color: #ffffff;
}

.voucher-details {
  margin-bottom: 1.5rem;
}

.bartender-section {
  border-top: 1px solid #333;
  padding-top: 1.5rem;
}

.bartender-section h3 {
  text-align: center;
  margin-bottom: 1rem;
}

.bartender-instructions {
  margin-bottom: 1.5rem;
}

.bartender-instructions ol {
  margin-left: 1.5rem;
}

.confirm-btn {
  width: 100%;
  padding: 1rem;
  font-size: 1.1rem;
  font-weight: 700;
}

.terms-conditions {
  font-size: 0.8rem;
  color: #aaaaaa;
  text-align: center;
}

/* Success confirmation */
.voucher-confirmation-container,
.visit-confirmation-success {
  text-align: center;
  padding: 3rem 2rem;
}

.success-icon {
  background-color: #ff007f;
  color: white;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  font-size: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1.5rem;
}

.auto-close-note {
  margin-top: 2rem;
  font-size: 0.9rem;
  color: #aaaaaa;
  font-style: italic;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  h1 {
    font-size: 2rem;
  }
  
  h2 {
    font-size: 1.5rem;
  }
  
  .landing-form-container,
  .voucher-form-container,
  .otp-verification-container,
  .voucher-display-container,
  .success-container,
  .admin-login-container,
  .visit-confirmation-container,
  .admin-dashboard-container {
    padding: 1.5rem;
  }
  
  .otp-input {
    width: 2.5rem !important;
    height: 2.5rem;
    font-size: 1.2rem;
  }
}

================
File: src/index.js
================
import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import App from './App';
import reportWebVitals from './reportWebVitals';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

// If you want to start measuring performance in your app, pass a function
// to log results (for example: reportWebVitals(console.log))
// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals
reportWebVitals();

================
File: src/logo.svg
================
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 841.9 595.3"><g fill="#61DAFB"><path d="M666.3 296.5c0-32.5-40.7-63.3-103.1-82.4 14.4-63.6 8-114.2-20.2-130.4-6.5-3.8-14.1-5.6-22.4-5.6v22.3c4.6 0 8.3.9 11.4 2.6 13.6 7.8 19.5 37.5 14.9 75.7-1.1 9.4-2.9 19.3-5.1 29.4-19.6-4.8-41-8.5-63.5-10.9-13.5-18.5-27.5-35.3-41.6-50 32.6-30.3 63.2-46.9 84-46.9V78c-27.5 0-63.5 19.6-99.9 53.6-36.4-33.8-72.4-53.2-99.9-53.2v22.3c20.7 0 51.4 16.5 84 46.6-14 14.7-28 31.4-41.3 49.9-22.6 2.4-44 6.1-63.6 11-2.3-10-4-19.7-5.2-29-4.7-38.2 1.1-67.9 14.6-75.8 3-1.8 6.9-2.6 11.5-2.6V78.5c-8.4 0-16 1.8-22.6 5.6-28.1 16.2-34.4 66.7-19.9 130.1-62.2 19.2-102.7 49.9-102.7 82.3 0 32.5 40.7 63.3 103.1 82.4-14.4 63.6-8 114.2 20.2 130.4 6.5 3.8 14.1 5.6 22.5 5.6 27.5 0 63.5-19.6 99.9-53.6 36.4 33.8 72.4 53.2 99.9 53.2 8.4 0 16-1.8 22.6-5.6 28.1-16.2 34.4-66.7 19.9-130.1 62-19.1 102.5-49.9 102.5-82.3zm-130.2-66.7c-3.7 12.9-8.3 26.2-13.5 39.5-4.1-8-8.4-16-13.1-24-4.6-8-9.5-15.8-14.4-23.4 14.2 2.1 27.9 4.7 41 7.9zm-45.8 106.5c-7.8 13.5-15.8 26.3-24.1 38.2-14.9 1.3-30 2-45.2 2-15.1 0-30.2-.7-45-1.9-8.3-11.9-16.4-24.6-24.2-38-7.6-13.1-14.5-26.4-20.8-39.8 6.2-13.4 13.2-26.8 20.7-39.9 7.8-13.5 15.8-26.3 24.1-38.2 14.9-1.3 30-2 45.2-2 15.1 0 30.2.7 45 1.9 8.3 11.9 16.4 24.6 24.2 38 7.6 13.1 14.5 26.4 20.8 39.8-6.3 13.4-13.2 26.8-20.7 39.9zm32.3-13c5.4 13.4 10 26.8 13.8 39.8-13.1 3.2-26.9 5.9-41.2 8 4.9-7.7 9.8-15.6 14.4-23.7 4.6-8 8.9-16.1 13-24.1zM421.2 430c-9.3-9.6-18.6-20.3-27.8-32 9 .4 18.2.7 27.5.7 9.4 0 18.7-.2 27.8-.7-9 11.7-18.3 22.4-27.5 32zm-74.4-58.9c-14.2-2.1-27.9-4.7-41-7.9 3.7-12.9 8.3-26.2 13.5-39.5 4.1 8 8.4 16 13.1 24 4.7 8 9.5 15.8 14.4 23.4zM420.7 163c9.3 9.6 18.6 20.3 27.8 32-9-.4-18.2-.7-27.5-.7-9.4 0-18.7.2-27.8.7 9-11.7 18.3-22.4 27.5-32zm-74 58.9c-4.9 7.7-9.8 15.6-14.4 23.7-4.6 8-8.9 16-13 24-5.4-13.4-10-26.8-13.8-39.8 13.1-3.1 26.9-5.8 41.2-7.9zm-90.5 125.2c-35.4-15.1-58.3-34.9-58.3-50.6 0-15.7 22.9-35.6 58.3-50.6 8.6-3.7 18-7 27.7-10.1 5.7 19.6 13.2 40 22.5 60.9-9.2 20.8-16.6 41.1-22.2 60.6-9.9-3.1-19.3-6.5-28-10.2zM310 490c-13.6-7.8-19.5-37.5-14.9-75.7 1.1-9.4 2.9-19.3 5.1-29.4 19.6 4.8 41 8.5 63.5 10.9 13.5 18.5 27.5 35.3 41.6 50-32.6 30.3-63.2 46.9-84 46.9-4.5-.1-8.3-1-11.3-2.7zm237.2-76.2c4.7 38.2-1.1 67.9-14.6 75.8-3 1.8-6.9 2.6-11.5 2.6-20.7 0-51.4-16.5-84-46.6 14-14.7 28-31.4 41.3-49.9 22.6-2.4 44-6.1 63.6-11 2.3 10.1 4.1 19.8 5.2 29.1zm38.5-66.7c-8.6 3.7-18 7-27.7 10.1-5.7-19.6-13.2-40-22.5-60.9 9.2-20.8 16.6-41.1 22.2-60.6 9.9 3.1 19.3 6.5 28.1 10.2 35.4 15.1 58.3 34.9 58.3 50.6-.1 15.7-23 35.6-58.4 50.6zM320.8 78.4z"/><circle cx="420.9" cy="296.5" r="45.7"/><path d="M520.5 78.1z"/></g></svg>

================
File: src/reportWebVitals.js
================
const reportWebVitals = onPerfEntry => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
};

export default reportWebVitals;

================
File: src/setupTests.js
================
// jest-dom adds custom jest matchers for asserting on DOM nodes.
// allows you to do things like:
// expect(element).toHaveTextContent(/react/i)
// learn more: https://github.com/testing-library/jest-dom
import '@testing-library/jest-dom';



================================================================
End of Codebase
================================================================
